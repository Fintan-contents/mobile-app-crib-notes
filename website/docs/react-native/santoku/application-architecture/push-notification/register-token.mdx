---
title: 登録トークンの登録・更新
---

ログイン時に登録トークンを登録・更新します。
登録・更新する条件は次の通りです。

- 通知が許可されている
- アカウント情報の登録トークン一覧に現在の登録トークンがない

## 処理フロー

処理フローは以下になります。

![登録トークンの登録・更新の処理フロー](register-token.drawio.png)

| No | 処理 | 内容 |
|:--|:--|:--|
| ① | アカウント情報の取得 |  アカウント情報取得APIを呼び出して、ログイン済みアカウントに紐づく登録トークン一覧を取得します。登録トークン一覧は空の配列か1つの登録トークンを含んだ配列となります（将来的に同一アカウントでの複数端末対応に備え配列としています）。登録トークン一覧に現在の登録トークンがない場合、登録または更新が必要です。登録トークンの定期的な更新を促すため、登録日時が1か月以上前の登録トークンはレスポンスに含まれません。 |
| ② | 通知許可を要求 | 通知許可を要求します。Androidの場合この検証は常に有効（AUTHORIZED）となります。iOSやiPadOSの場合、初回のみ通知許可の確認ダイアログが表示されます。詳細は、[iOS - Requesting permissions](https://rnfirebase.io/messaging/usage#ios---requesting-permissions)を参照してください。|
| ③ | 現在の登録トークンを取得 | 通知許可が有効（AUTHORIZED）な場合、現在の登録トークンを取得します。 |
| ④ | 登録トークンの登録・更新 | レスポンスの登録トークン一覧に現在の登録トークンがない場合、登録トークンを登録・更新します。③で取得した登録トークンを指定して登録トークン登録・更新APIを呼び出します。 |
| ⑤ | 登録トークンの検証 | 登録トークンをデータベースへ保存する前に、登録トークンが有効な値かを検証します。検証はdryRunオプションをtrueにしてFCMへプッシュ通知を送信することで行います。dryRunオプションがtrueの場合、端末に通知は行わず検証のみが実施されます。 |
| ⑥ | 登録トークンを保存 | 更新後の登録トークンが有効な場合、データベースへ保存し、正常応答を返します。無効な場合はトランザクションをロールバックし、異常応答を返します。 |
