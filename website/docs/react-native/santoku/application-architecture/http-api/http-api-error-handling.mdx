---
title: HTTP API通信で発生するエラーのハンドリング
---

HTTP APIは、HTTPステータスコードを使用して処理の成功と失敗を表します。

| HTTPステータスコード | 意味                         |
| :---------------- | :-------------------------- |
| 2xx               | 成功                         |
| 4xx               | クライアントサイドに起因するエラー |
| 5xx               | サーバサイドに起因するエラー      |

HTTPステータスコードが4xxの場合は、モバイルアプリケーションの操作によって解決が可能なエラーになります。HTTPステータスコードが5xxの場合は、モバイルアプリケーションの操作では解決できないエラーとなります。

## HTTPステータスコードが4xxのエラーハンドリング

以下のHTTPステータスコードが返却された場合、ユーザにエラーの内容と解消のための適切な手順を伝えます。ここに含まれないHTTPステータスコードの場合は、想定外のエラーが発生したことを促すダイアログを表示します。

| HTTPステータスコード | 意味                                                                        |
| :---------------- | :------------------------------------------------------------------------- |
| 400               | BadRequest - リクエストとして送るペイロードがバリデーションエラーになった場合など       |
| 401               | Unauthorized - 認証トークンの期限が切れた場合                                    |
| 404               | Not found - リソースが見つからなかった場合                                       |
| 412               | Precondition Failed - 操作しているモバイルアプリケーションが強制アップデート対象の場合 |
| 429               | Too many requests - クライアントから大量のリクエストが送信された場合                |

4xxのHTTPステータスコードが返却された場合、SantokuAppの動作は以下のようになります。

| HTTPステータスコード | SantokuAppの動作                                                              |
| :---------------- | :------------------------------------------------------------------------- |
| 400               | デフォルトの動作では、特に処理を実施しません。SantokuAppではクライアントバリデーションを実施するため基本的には発生しない想定です。クライアントでは実施できないバリデーションなどがある機能に関しては、個別にエラー処理を実施してください。 |
| 401               | デフォルトの動作では、期限が切れた認証トークンを破棄して新しい認証トークンを再取得します。認証トークンを取得後、HTTP API通信をリトライします。 |
| 404               | デフォルトの動作では、特に処理を実施しません。あるユーザがアクセスしようとしている情報が、他のユーザに削除されてしまった場合などに発生する可能性があります。そういったユースケースが存在する機能に関しては、個別にエラー処理を実施してください。 |
| 412               | デフォルトの動作では、アプリを新しいバージョンにアップデートするように促すダイアログを表示します。アプリを新しいバージョンにアップデートするまでは常にこのダイアログが表示され、ユーザは他の操作をできません。 |
| 429               | デフォルトの動作では、時間をおいてから再操作をするように促すダイアログを表示します。|
| その他             | デフォルトの動作では、想定外のエラーが発生したことを伝えるダイアログを表示します。また、エラー内容をFirebase Crashlyticsに送信します。 |

## HTTPステータスコードが5xxのエラーハンドリング

SantokuAppではHTTPステータスコードが503の場合、ユーザにシステムメンテナンス中であることを伝えます。ここに含まれないHTTPステータスコードの場合は、想定外のエラーが発生したことを促すダイアログを表示します。

| HTTPステータスコード | 意味                                                                        |
| :---------------- | :------------------------------------------------------------------------- |
| 503               | Service Unavailable - HTTP APIがシステムメンテナンスで止まっている場合             |

5xxのHTTPステータスコードが返却された場合、SantokuAppの動作は以下のようになります。

| HTTPステータスコード | SantokuAppの動作                                                              |
| :---------------- | :------------------------------------------------------------------------- |
| 503               | デフォルトの動作では、システムメンテナンス中であることを伝えるダイアログを表示します。 |
| その他             | デフォルトの動作では、想定外のエラーが発生したことを伝えるダイアログを表示します。また、エラー内容をFirebase Crashlyticsに送信します。 |

## HTTP APIからレスポンスが返却されない場合のエラーハンドリング

HTTP APIからレスポンスが返却されない場合は、以下のような原因が考えられます。

- 端末のネットワークがOFFになっている場合
- HTTP APIとの通信中にネットワークが切断された場合
- 接続先サーバのポートにアクセスできない場合

これらの場合は、ネットワークの状態を確認してもらうか、時間をおいてから再操作をするように促すダイアログを表示します。

## HTTP API通信のタイムアウト

HTTP APIとの通信が1分以上経過した場合、通信を強制的にキャンセルします。この場合は、ネットワークの状態を確認してもらうか、時間をおいてから再操作をするように促すダイアログを表示します。

:::note
axiosでは[timeout](https://github.com/axios/axios#request-config)を設定できます。axiosの`timeout`は、Androidではコネクションタイムアウトのみに使用されるため、コネクション接続後にサーバの応答が遅い場合などはタイムアウトしません。

そのため、SantokuAppではaxiosの`timeout`を使用せず、[CancelToken](https://github.com/axios/axios#cancellation)を利用して独自にHTTP API通信をキャンセルすることによりタイムアウトを実現しています。
:::

## HTTP API通信のリトライ

HTTP API通信で発生したエラー内容に応じて、HTTP APIのリクエストを再試行します。

| エラー原因                                       | リトライ回数  |
| :--------------------------------------------- | :---------- |
| HTTPステータスコードが400                         | リトライしない |
| HTTPステータスコードが401                         | 1回          |
| HTTPステータスコードが404                         | リトライしない |
| HTTPステータスコードが412                         | リトライしない |
| HTTPステータスコードが429                         | 2回          |
| HTTPステータスコードが503                         | リトライしない |
| HTTPステータスコードが上記以外                      | 2回          |
| HTTP APIからレスポンスが返却されない場合             | 2回          |
