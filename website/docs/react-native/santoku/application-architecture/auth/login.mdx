---
title: ログイン
---

このアプリでは、ユーザが本人であることを確認するために、Cookieベースの認証機能を提供します。ID・パスワードを用いて認証し、バックエンドから払い出されたセッションIDをCookieに設定することで認証状態を維持します。

なお、このアプリではログインの手段として、前回ログインしていたアカウントでの自動ログインとログアウト後のログインを提供します。

- ログイン画面でアカウントIDを入力して、バックエンドにログインリクエストを送信
- 端末に保存されたログイン資格情報を用いて、バックエンドにログインリクエストを送信（以降、自動ログインと呼びます）

## ログイン画面でアカウントIDを入力してログイン

アプリからログアウトした場合は、ログイン画面からアカウントIDを入力してログインします。パスワードは、[サインアップ](signup.mdx)後に保存したセキュアストレージから取得します。

### 処理フロー

![ログイン画面でアカウントIDを入力してログインする場合の処理フロー](auth-login-screen-flow.drawio.png)

| No | 処理 | 内容 |
|:--|:--|:--|
| ① | アカウントIDの入力 | ユーザは、ログイン画面でアカウントIDを入力します。 |
| ② | パスワードの取得 | アプリは、セキュアストレージからアカウントIDに紐づくパスワード取得します。 |
| ③ | ログインのリクエスト | アプリは、アカウントIDとパスワードを用いてバックエンドにログインリクエストを送ります。 |
| ④ | 認証 | バックエンドは、ログインリクエストで受け取ったアカウントIDとパスワードを用いて認証処理をします。 |
| ⑤ | 認証結果の返却 | バックエンドは認証処理の結果をアプリに返却します。|
| ⑥ | Cookieの保存 | アプリは、バックエンドから認証処理の結果を受け取って、Cookie（セッションID）を保存します。Cookieの保存に関しては、[認証状態の維持](login.mdx#認証状態の維持)を参照してください。 |
| ⑦ | ログインしたアカウントIDを保存 | アプリは、入力されたアカウントIDをセキュアストレージに保存します。 |

### 利用方法

ログインは`AuthenticationService`の`changeAccount`メソッドを使用します。このメソッドを使用する前に、バックエンドからCSRFトークンを取得する必要があります。ログインに成功するとCSRFトークンが更新されるため、再度CSRFトークンを取得する必要があります。

```typescript title="ログイン画面からログインする場合の利用方法"
import {AuthenticationService, csrfToken} from 'framework';

const changeAccount = useCallback(async () => {
  try {
    // CSRFトークンの取得
    await csrfToken();
    // 入力されたアカウントIDを使用してログイン
    await AuthenticationService.changeAccount(accountId);
    // CSRFトークンの取得
    await csrfToken();
  } catch (e) {
    // エラー処理
  }
}, [accountId]);
```

## 自動ログイン

ログイン資格情報をセキュアストレージから取得してログインします。ユーザにログイン操作を要求することなくログインできるため、アプリの利便性が向上します。

このアプリでは、以下の場合に自動ログインをします。

- サインアップに成功した場合
- アプリにログイン後、ログアウトせずにアプリを終了してアプリを再起動した場合
- アプリ使用中にセッションIDの有効期限が切れた場合

<!-- markdownlint-disable MD024 -->

### 処理フロー

<!-- markdownlint-enable MD024 -->

![自動ログインの処理フロー](auth-auto-login-flow.drawio.png)

| No | 処理 | 内容 |
|:--|:--|:--|
| ① | ログイン資格情報の取得 | アプリは、セキュアストレージから前回ログインしていたアカウントIDと、そのアカウントIDに紐づくパスワード取得します。<br/>ただし、サインアップ後は前回ログインしていたアカウントIDではなく、[バックエンドから返却されたアカウントID](signup.mdx#処理フロー)を使用します。 |
| ② | ログインのリクエスト | アプリは、アカウントIDとパスワードを用いてバックエンドにログインリクエストを送ります。 |
| ③ | 認証 | バックエンドは、ログインリクエストで受け取ったアカウントIDとパスワードを用いて認証処理をします。 |
| ④ | 認証結果の返却 | バックエンドは認証処理の結果をアプリに返却します。|
| ⑤ | Cookieの保存 | アプリは、バックエンドから認証処理の結果を受け取って、Cookie（セッションID）を保存します。Cookieの保存に関しては、[認証状態の維持](login.mdx#認証状態の維持)を参照してください。 |

<!-- markdownlint-disable MD024 -->

### 利用方法

<!-- markdownlint-enable MD024 -->

ログインは`AuthenticationService`の`autoLogin`メソッドを使用します。このメソッドを使用する前に、バックエンドからCSRFトークンを取得する必要があります。自動ログインに成功した後、バックエンドにアクセスするためには、CSRFトークンを再度取得する必要があります。

また、自動ログインする前に、自動ログインが可能かを検証します。前回ログインしていたアカウントIDと、そのアカウントIDに紐づくパスワードをセキュアストレージから取得できるかで、自動ログインが可能かどうかを検証しています。

```typescript title="自動ログインの利用方法"
import {AuthenticationService, csrfToken} from 'framework';

const autoLogin = useCallback(async () => {
  try {
    const canAutoLogin = await AuthenticationService.canAutoLogin();
    // 自動ログインが可能の場合は、自動ログインする
    if (canAutoLogin) {
      // CSRFトークンの取得
      await csrfToken();
      await AuthenticationService.autoLogin();
      // CSRFトークンの取得
      await csrfToken();
      return;
    }

    // 自動ログインできない場合は、ログイン画面に遷移するなどの処理を実装してください

  } catch (e) {
    // エラー処理
  }
}, []);
```

## 認証状態の維持

バックエンドへのHTTPリクエスト送信時に、Cookie経由でセッションIDを渡すことにより認証状態を維持します。

認証後に受け取ったCookie（セッションID）など、HTTPレスポンスとして受け取ったCookieは、ネイティブの機能で端末内に自動で保持されます。バックエンドへのHTTPリクエスト送信時には、ネイティブの機能でCookie（セッションID）を透過的に設定します。

なお、セッションIDには有効期限があります。有効期限切れを検知した場合は、自動ログインを使用してアプリが自動的に再度セッションIDを取得します。
