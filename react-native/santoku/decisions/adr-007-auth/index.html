<!doctype html>
<html class="docs-version-current" lang="ja" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<title data-react-helmet="true">認証方式の方針 | Fintan » Mobile App Development</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://fintan-contents.github.io/mobile-app-crib-notes/react-native/santoku/decisions/adr-007-auth"><meta data-react-helmet="true" name="docusaurus_locale" content="ja"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="認証方式の方針 | Fintan » Mobile App Development"><meta data-react-helmet="true" name="description" content="Status: Accepted"><meta data-react-helmet="true" property="og:description" content="Status: Accepted"><link data-react-helmet="true" rel="icon" href="/mobile-app-crib-notes/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://fintan-contents.github.io/mobile-app-crib-notes/react-native/santoku/decisions/adr-007-auth"><link data-react-helmet="true" rel="alternate" href="https://fintan-contents.github.io/mobile-app-crib-notes/react-native/santoku/decisions/adr-007-auth" hreflang="ja"><link data-react-helmet="true" rel="alternate" href="https://fintan-contents.github.io/mobile-app-crib-notes/react-native/santoku/decisions/adr-007-auth" hreflang="x-default"><link rel="stylesheet" href="/mobile-app-crib-notes/assets/css/styles.b7fb2c2f.css">
<link rel="preload" href="/mobile-app-crib-notes/assets/js/runtime~main.0aa8e411.js" as="script">
<link rel="preload" href="/mobile-app-crib-notes/assets/js/main.f45db73b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">メインコンテンツまでスキップ</a></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://fintan.jp" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/mobile-app-crib-notes/img/fintan-logo.jpg" alt="Fintan Mobile App" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/mobile-app-crib-notes/img/fintan-logo.jpg" alt="Fintan Mobile App" class="themedImage_1VuW themedImage--dark_hz6m"></div></a><a class="navbar__item navbar__link" href="/mobile-app-crib-notes/">Home</a><a class="navbar__item navbar__link" href="/mobile-app-crib-notes/reference">Reference</a><a class="navbar__item navbar__link" href="/mobile-app-crib-notes/distribution">Distribution</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">React Native</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/mobile-app-crib-notes/react-native/learn">Learn</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/mobile-app-crib-notes/react-native/santoku">Example App</a></li><li><a class="dropdown__link" href="/mobile-app-crib-notes/react-native/common-pitfalls">Pitfalls</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/fintan-contents/mobile-app-crib-notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo sidebarWithHideableNavbar_267A"><a href="https://fintan.jp" target="_blank" rel="noopener noreferrer" tabindex="-1" class="sidebarLogo_3h0W"><img src="/mobile-app-crib-notes/img/fintan-logo.jpg" alt="Fintan Mobile App" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/mobile-app-crib-notes/img/fintan-logo.jpg" alt="Fintan Mobile App" class="themedImage_1VuW themedImage--dark_hz6m"></a><nav class="menu thin-scrollbar menu_Bmed"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/mobile-app-crib-notes/react-native/santoku">はじめに</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/mobile-app-crib-notes/react-native/santoku/requirements">Requirements</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/mobile-app-crib-notes/react-native/santoku/application-architecture">Application Architecture</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/mobile-app-crib-notes/react-native/santoku/test-planning">Test Planning</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/mobile-app-crib-notes/react-native/santoku/design">Design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/mobile-app-crib-notes/react-native/santoku/development">Development</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/mobile-app-crib-notes/react-native/santoku/glossary">Glossary</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_2fq0" href="/mobile-app-crib-notes/react-native/santoku/decisions">Decision Records</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions">目次</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-001-error-handling">グローバルエラーハンドリング</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-002-http-api-libraries">HTTP通信で使用するライブラリ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-003-http-api-error-handling">HTTP API通信で発生するエラーのハンドリング</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-004-deep-link">ディープリンクの実現方式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-005-message">メッセージ管理の方針</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-006-logging">ログ出力の方針</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-007-auth">認証方式の方針</a></li></ul></li></ul></nav><button type="button" title="サイドバーを隠す" aria-label="サイドバーを隠す" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>認証方式の方針</h1></header><p>Status: Accepted</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="要約">要約<a class="hash-link" href="#要約" title="見出しへの直接リンク">​</a></h2><ul><li>認証手段としてCookieベースの認証を採用します。</li><li>ログイン時（自動ログインを含む）に端末認証を要求することで、モバイル端末の紛失や盗難リスクに対応します。</li><li>匿名サインアップや自動ログインにより、アプリの利便性を向上させます。</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="コンテキスト">コンテキスト<a class="hash-link" href="#コンテキスト" title="見出しへの直接リンク">​</a></h2><p>アプリケーションを安全かつ利便的に使用するためには、ユーザが本人その人であることを確認する必要があります。
認証とは、ユーザがその人自身であることを確認する手段です。
通常はログイン機能として提供されます。</p><p>認証は、利用者が提示する認証要素を確認することで実現します。
認証要素には次のものがあります。</p><ul><li>知識情報。その人自身しか知らない情報。「パスワード」「PINコード」や「秘密の質問」など。</li><li>所持情報。その人自身が保有する情報。「電話番号」「ハードウェアトークン」「クライアント証明書」など。</li><li>生体情報。その人自身の特徴。「指紋」「静脈」「声紋」や「顔の特徴」など。</li></ul><p>一般的には、パスワードを用いた認証方式を採用するサービスが多いです。
しかし、昨今の高まるセキュリティリスクに対応するため、安全性が求められるサービスでは多要素認証を採用するケースも増えています。</p><p>ここでは、サンプルアプリケーションの認証方式について検討します。
目指す認証方式は次の通りです。</p><ul><li>アプリを安全かつ利便的に使用できること</li><li>他のプロジェクトでも参考にしやすいこと</li></ul><p>サンプルアプリケーションの存在趣旨を踏まえ、他のプロジェクトでの参考のし易さを第一とします。
一般的に認証に関連して必要となるアカウント機能（アカウントのライフサイクルにまつわる機能群）は対象外とし、サインアップ・ログイン・ログアウトといった認証機能にのみ焦点を当てます。
また、プロジェクトによって異なる箇所の多い認証方式は検討対象外とします。</p><p>次の観点で認証方式について議論・調査を進めていきます。</p><ul><li>認証手段</li><li>サインアップ</li><li>ログイン</li><li>ログアウト</li><li>想定される脅威（攻撃手法）とその対応</li><li>想定される課題とその対応</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="議論">議論<a class="hash-link" href="#議論" title="見出しへの直接リンク">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="認証手段">認証手段<a class="hash-link" href="#認証手段" title="見出しへの直接リンク">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="oidc-vs-cookieベースの認証">OIDC vs Cookieベースの認証<a class="hash-link" href="#oidc-vs-cookieベースの認証" title="見出しへの直接リンク">​</a></h4><p>OIDC（OpenID Connect）は、OAuth 2.0プロトコルを使用して構築された認証方式です。
Cookieベースの認証とは、パスワードを用いて認証し、CookieでセッションIDを受け取る一般的な認証方式です。</p><p>認証手段の検討にあたり、真っ先に検討の場に上がるのはOIDC（OpenID Connect）です。
OIDCは標準化された仕様を持つ優れた認証方式ですが、次の理由により検討対象外としました。</p><ul><li>OIDCを用いる場合、認証サーバ（IdP）に外部サービス（Firebase AuthenticationやAmazon Cognitoなど）を用いる場合が多い。外部サービスから開発ガイドやSDKが提供されており、実装する場合はそちらを参考にできる。</li><li>Cookieベースの認証機能を備えた既存資産の流用を考えた場合、OIDCへの移行はコストがかかる。</li></ul><p>よって、他のプロジェクトでの参考のし易さを第一とし、サンプルアプリケーションではCookieベースの認証を採用します。</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>アプリ自身の実装としてCookieは操作しますが、保存先や保存期間などの管理はネイティブに委ねています。
そのため、アプリではCookieを管理しません。</p></div></div><p>React NativeでCookieを扱う場合、<a href="https://reactnative.dev/docs/network#known-issues-with-fetch-and-cookie-based-authentication" target="_blank" rel="noopener noreferrer">Known Issues with fetch and cookie based authentication</a>の確認が必要です。
こちらについては、<a href="#react-native%E3%81%A7cookie%E3%82%92%E6%89%B1%E3%81%86%E5%A0%B4%E5%90%88%E3%81%AE%E6%87%B8%E5%BF%B5%E7%82%B9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">React NativeでCookieを扱う場合の懸念点について</a>に調査結果を纏めていますので参考にしてください。</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="端末認証">端末認証<a class="hash-link" href="#端末認証" title="見出しへの直接リンク">​</a></h4><p>モバイルアプリの場合、Webアプリケーションとは異なり、端末の紛失や盗難といったセキュリティリスクがあります。
そうしたリスクへの対応として端末認証があります。
端末認証は、PINコード（またはパスコード）、指紋や顔の特徴などを用いて、ユーザが端末の所持者であることを認証します。
これにより、所持者以外が不正に端末を利用することを防げます。</p><p>このアプリでも、ログイン時に端末認証を要求することで、上記リスクに対応します。</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="サインアップ">サインアップ<a class="hash-link" href="#サインアップ" title="見出しへの直接リンク">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="匿名サインアップ">匿名サインアップ<a class="hash-link" href="#匿名サインアップ" title="見出しへの直接リンク">​</a></h4><p>アプリへのサインアップ要求は、ユーザの心理的抵抗が大きいです。
「アカウント情報の登録が面倒」という理由からくるユーザの離脱は、大きな機会損失に繋がります。</p><p>そこで、このアプリでは匿名サインアップ機能を提供します。
ユーザはサインアップ操作なしに匿名アカウントを使用してアプリの利用を開始できます。
匿名サインアップは次の流れで行います。</p><ol><li>アカウントIDとパスワードをアプリケーションが自動作成</li><li>自動生成したアカウントIDとパスワードでサインアップ</li><li>ログイン資格情報を端末内の安全な場所に保存</li></ol><p>ログイン資格情報は、次回ログイン時に必要となる情報です。
ログイン資格情報の詳細については、<a href="#%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3">ログイン</a>で検討します。</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>端末内の安全な場所の詳細は、<a href="/mobile-app-crib-notes/reference/auth/manage-credentials">ログイン資格情報の管理</a>を参照してください。</p></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>パスワードは知識情報（その人自身しか知らない情報）に当たるので、アプリケーションが自動生成するのはおかしいのではという疑問が生じます。
このアプリでは、自動生成されたパスワード（から得たログイン資格情報）を知識情報ではなく所持情報（その人自身が保有する情報）として扱います。
他の例でいうと、パスワード管理サービス（1Passwordのような）を利用することで、ユーザはパスワードを記憶しなくて済みます。
これは実質的に、パスワードを所持情報として扱っていると言えるでしょう。</p></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="匿名アカウントと通常アカウント">匿名アカウントと通常アカウント<a class="hash-link" href="#匿名アカウントと通常アカウント" title="見出しへの直接リンク">​</a></h4><p>匿名サインアップ後のアカウントは匿名アカウントとして扱います。</p><p>一方で、アカウント登録やアカウント連携が完了したアカウントを通常アカウントとして扱います。
開発リソース上の理由により、通常アカウントの導入は今回の開発範囲外とします。</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="ログイン">ログイン<a class="hash-link" href="#ログイン" title="見出しへの直接リンク">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="自動ログイン">自動ログイン<a class="hash-link" href="#自動ログイン" title="見出しへの直接リンク">​</a></h4><p>頻繁なログイン操作の要求は、ユーザの利便性低下に繋がります。
またこういった要求が、単純な（安全性の低い）パスワードの利用やパスワードの使いまわしにも繋がります。
そもそもこのアプリの場合、匿名アカウント使用ユーザは自身の（自動生成された）パスワードを知らないので、パスワードを入力できません。</p><p>そこで、このアプリでは自動ログイン機能を提供します。
アプリ起動時に、端末内に保存されたログイン資格情報を用いて（前回ログインしたアカウントで）自動でログインします。</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="ログイン資格情報">ログイン資格情報<a class="hash-link" href="#ログイン資格情報" title="見出しへの直接リンク">​</a></h4><p>ログイン資格情報の仕様について、次の案を検討しました。</p><ul><li>アカウントID + パスワード</li><li>認証トークン</li></ul><p>ここでいう認証トークンとは、ログイン時にバックエンドが発行する文字列（トークン）です。
トークンには有効期限などの付加情報を追加したり、電子署名による改ざん対策が可能です。</p><p>ログイン資格情報は、上記いずれの案を用いたとしても、通信経路上および端末内での安全性が保たれています。
今回はアプリの特性と既存資産の流用のし易さを考慮し、ログイン資格情報に「アカウントID + パスワード」を採用します。</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="認証状態の保持">認証状態の保持<a class="hash-link" href="#認証状態の保持" title="見出しへの直接リンク">​</a></h4><p>セッションの有効期限が切れた場合、アプリが自動で再度ログインしてセッションを更新します。
詳細は、<a href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-003-http-api-error-handling#cookie%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E8%AA%8D%E8%A8%BC">【補足】有効期限が切れたログイン資格情報の更新方法 - Cookieベースの認証</a>を参照してください。</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="ログアウト">ログアウト<a class="hash-link" href="#ログアウト" title="見出しへの直接リンク">​</a></h3><p>ログアウト時に端末内のログイン資格情報を削除します。
匿名アカウントはログアウトすると再ログイン出来なくなるため、ログアウト操作が出来ません。
このアプリの<a href="/mobile-app-crib-notes/react-native/santoku/requirements/functional/overview">機能要件</a>にある「過去に作成したアカウントでログインできる」については、通常アカウントの導入で対応する予定です。</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="想定される脅威攻撃手法とその対応">想定される脅威（攻撃手法）とその対応<a class="hash-link" href="#想定される脅威攻撃手法とその対応" title="見出しへの直接リンク">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="ログイン機能に対する攻撃">ログイン機能に対する攻撃<a class="hash-link" href="#ログイン機能に対する攻撃" title="見出しへの直接リンク">​</a></h4><p>ログイン機能に対する攻撃として、SQLインジェクション、OSコマンド・インジェクションやバッファオーバーフローなどの攻撃があります。
これらの攻撃は、脆弱性を利用して認証機能を迂回したり、パスワードを盗み出します。
こういった脆弱性への対策はバックエンド側となる為、アプリの対応範囲外です。</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="パスワード認証に対する攻撃">パスワード認証に対する攻撃<a class="hash-link" href="#パスワード認証に対する攻撃" title="見出しへの直接リンク">​</a></h4><p>パスワード認証に対する攻撃として、次のようなものがあります。</p><ul><li>辞書攻撃</li><li>ジョーアカウント探索</li><li>ブルートフォース攻撃（総当たり攻撃）</li><li>パスワードスプレー攻撃</li><li>リバースブルートフォース攻撃</li><li>パスワードリスト攻撃</li></ul><p>パスワードを自動生成することで結果的に防げている攻撃もありますが、この攻撃への対策はバックエンド側となる為、アプリの対応範囲外です。</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="ソーシャルエンジニアリング">ソーシャルエンジニアリング<a class="hash-link" href="#ソーシャルエンジニアリング" title="見出しへの直接リンク">​</a></h4><p>ソーシャルエンジニアリングは、ユーザをだましてパスワードを聞き取る攻撃手法です。
この攻撃はアプリケーションで対策するものではありません。一般的に教育での対応となります。
ただし、このアプリの匿名アカウント使用ユーザは自身のパスワードを知らないので、結果的に攻撃を防げています。</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="フィッシング">フィッシング<a class="hash-link" href="#フィッシング" title="見出しへの直接リンク">​</a></h4><p>本物そっくりの画面を備えた偽サイトを仕立てて、利用者の情報を入手する攻撃手法です。
基本的にユーザの注意により防ぐ攻撃です。
一般的にWebアプリケーションを標的とした攻撃であることと、このアプリの匿名アカウント使用ユーザはパスワードを手入力しないことから、脅威レベルとしては低いものとなります。</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="クロスサイトリクエストフォージェリcsrf">クロスサイト・リクエストフォージェリ（CSRF）<a class="hash-link" href="#クロスサイトリクエストフォージェリcsrf" title="見出しへの直接リンク">​</a></h4><p>CSRFは、Cookieの特性を利用した攻撃手法です。
アプリケーションにCSRF脆弱性が存在すると、ログイン中のユーザは意図せず「重要な処理」を実行させられる場合があります。
一般的にWebアプリケーションを標的とした攻撃であるため、モバイルアプリとしての脅威レベルは低いものとなります。ただし、WebViewやIn-App Browserを利用している場合は脅威となりえます。
今回はバックエンドがCSRF対応をしている前提のもと、バックエンドから受け取ったCSRFトークンをHTTP通信時にHTTPヘッダへ含めます。</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="セッションハイジャック">セッションハイジャック<a class="hash-link" href="#セッションハイジャック" title="見出しへの直接リンク">​</a></h4><p>セッションハイジャック手法としては次のようなものがあります。</p><ul><li>セッションIDの推測</li><li>セッションIDの盗み出し</li><li>セッションIDの強制</li></ul><p>この攻撃への対策はバックエンド側となる為、アプリの対応範囲外です。</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="モバイル端末の紛失や盗難">モバイル端末の紛失や盗難<a class="hash-link" href="#モバイル端末の紛失や盗難" title="見出しへの直接リンク">​</a></h4><p>このアプリでは、次の方式でモバイル端末の紛失や盗難リスクに対応します。</p><ul><li>ログイン時（自動ログインを含む）の端末認証</li><li>端末内の安全な場所に秘密情報（ログイン資格情報）を保存</li></ul><p>ただし、モバイル端末の紛失や盗難リスクは、このアプリのみに留まりません。
そういったリスクに対しては、ユーザが端末のロック機能を有効にするなど、端末レベルでの紛失・盗難対策をしていることを前提としています。</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="不正サインアップ">不正サインアップ<a class="hash-link" href="#不正サインアップ" title="見出しへの直接リンク">​</a></h4><p>サービスの妨害を目的として、外部からの自動操作により不正なサインアップが大量に行われる場合があります。
このような攻撃への対処法として、WAFの導入があります。
また、ユーザのメールアドレスを利用した不正防止やCAPTCHAという仕組みでの対策方法も考えられます。
いずれにしても、アプリケーションのセキュリティ特性により対応レベルが異なりますので、今回は対応範囲外とします。</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="想定される課題とその対応">想定される課題とその対応<a class="hash-link" href="#想定される課題とその対応" title="見出しへの直接リンク">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="アプリの移行">アプリの移行<a class="hash-link" href="#アプリの移行" title="見出しへの直接リンク">​</a></h4><p>端末機種の切替などの理由によりアプリを移行する場合、その機能がこのアプリにはありません。
将来的には通常アカウントの機能を導入し、別の端末からログインする方法で対応する予定です。</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="ログイン資格情報の消失">ログイン資格情報の消失<a class="hash-link" href="#ログイン資格情報の消失" title="見出しへの直接リンク">​</a></h4><p>匿名アカウント使用ユーザが次の理由によりログイン資格情報を消失した場合、復旧手段がこのアプリにはありません。</p><ul><li>端末故障</li><li>アプリのアンインストール（Androidのみ発生。詳細は<a href="/mobile-app-crib-notes/reference/auth/manage-credentials#%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E8%B3%87%E6%A0%BC%E6%83%85%E5%A0%B1%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%95%E3%82%B5%E3%82%A4%E3%82%AF%E3%83%AB%E7%AE%A1%E7%90%86%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E6%B3%A8%E6%84%8F%E7%82%B9">ログイン資格情報のライフサイクル管理における注意点</a>を参照）</li></ul><p>将来的には通常アカウントの機能を導入し、別の端末からログインする方法で対応する予定です。</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="ログイン資格情報が盗まれた場合の対応">ログイン資格情報が盗まれた場合の対応<a class="hash-link" href="#ログイン資格情報が盗まれた場合の対応" title="見出しへの直接リンク">​</a></h4><p>ログイン資格情報が盗まれた場合の対応は、アカウント機能による運用対処とします。
システム管理者によるアカウント停止などを想定していますが、いずれにしても今回の検討対象外とします。</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="決定">決定<a class="hash-link" href="#決定" title="見出しへの直接リンク">​</a></h2><p>認証手段の検討にあたり、OIDCとCookieベースの認証を検討しました。
OIDCは優れた認証方式ですが、他のプロジェクトでの参考のし易さを第一としてCookieベースの認証を採用します。</p><p>モバイルアプリの場合、端末の紛失や盗難といったセキュリティリスクがあります。
そこで、ログイン時（自動ログインを含む）に端末認証を要求することで、モバイル端末の紛失や盗難リスクに対応します。</p><p>セキュリティとユーザの利便性は相反しやすい品質特性です。
このアプリではユーザの利便性を優先し、匿名サインアップや自動ログインを採用します。
サインアップ時に作成した「アカウントID + パスワード」を、ログイン資格情報として端末内の安全な場所に保存することで、自動ログインを実現します。</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="付録">付録<a class="hash-link" href="#付録" title="見出しへの直接リンク">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="react-nativeでcookieを扱う場合の懸念点について">React NativeでCookieを扱う場合の懸念点について<a class="hash-link" href="#react-nativeでcookieを扱う場合の懸念点について" title="見出しへの直接リンク">​</a></h3><p>React NativeでCookieを扱う場合、<a href="https://reactnative.dev/docs/network#known-issues-with-fetch-and-cookie-based-authentication" target="_blank" rel="noopener noreferrer">Known Issues with fetch and cookie based authentication</a>の確認が必要です。
こちらでは、Fetch APIとCookieベースの認証を組合わせた場合における、次の問題が報告されています。</p><ul><li>以下のオプションがfetchで動作しない<ul><li><code>redirect:manual</code></li><li><code>credentials:omit</code></li></ul></li><li>Androidで同じ名前のレスポンスヘッダーを受け取ると、最後に与えられたものだけが使用される</li><li><code>302</code>によるリダイレクト時に<code>Set-Cookie</code>ヘッダが存在すると、少なくともiOSでCookieが正しく設定されない</li></ul><p>このアプリではHTTP通信にaxiosを使います。
そのため、上記問題についてFetch APIとaxiosの双方で動作検証しました。
使用した環境は次の通りです。</p><ul><li>React Native: 0.64.3</li><li>Android実機、エミュレータ</li><li>iOS実機、シミュレータ</li></ul><p>検証方法は次の通りです。</p><ul><li><p>2つの<code>Set-Cookie</code>とHTTPステータス302を返すバックエンドAPI（以下、リダイレクト元API）を用意する</p></li><li><p>リダイレクト先のバックエンドAPI（以下、リダイレクト先API）を用意する</p></li><li><p>Fetch APIでリダイレクト元APIにアクセスする</p><ul><li><code>redirect</code>オプションを指定した場合</li><li><code>credentials</code>オプションを指定した場合</li><li><code>302</code>によるリダイレクト時に<code>Set-Cookie</code>ヘッダが存在した場合</li><li>同じ名前のレスポンスヘッダー（今回は<code>Set-Cookie</code>を使用）を受け取った場合</li></ul></li><li><p>axiosでリダイレクト元APIにアクセスする</p><ul><li><code>maxRedirects</code>オプションを指定した場合</li><li><code>withCredentials</code>オプションを指定した場合</li><li><code>302</code>によるリダイレクト時に<code>Set-Cookie</code>ヘッダが存在した場合</li><li>同じ名前のレスポンスヘッダー（今回は<code>Set-Cookie</code>を使用）を受け取った場合</li></ul></li></ul><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Fetch APIの<code>redirect</code>、および<code>credentials</code>オプションの詳細は、次のリンクをご確認ください。</p><ul><li><a href="https://developer.mozilla.org/ja/docs/Web/API/fetch" target="_blank" rel="noopener noreferrer">WindowOrWorkerGlobalScope.fetch()</a></li><li><a href="https://developer.mozilla.org/ja/docs/Web/API/Request/credentials" target="_blank" rel="noopener noreferrer">Request.credentials</a></li></ul></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>axiosの<code>maxRedirects</code>、および<code>withCredentials</code>オプションの詳細は、次のリンクをご確認ください。</p><ul><li><a href="https://axios-http.com/docs/req_config" target="_blank" rel="noopener noreferrer">Request Config</a></li></ul></div></div><p>検証結果は次の通りです。</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="fetch-api">Fetch API<a class="hash-link" href="#fetch-api" title="見出しへの直接リンク">​</a></h4><table><thead><tr><th rowspan="2" colspan="2" width="28%">検証内容</th><th colspan="2" width="36%">Android</th><th colspan="2" width="36%">iPhone</th></tr><tr><th width="18%">実機</th><th width="18%">エミュレータ</th><th width="18%">実機</th><th width="18%">シミュレータ</th></tr></thead><tbody><tr><td rowspan="3">redirect</td><td>follow</td><td colspan="4" rowspan="3">302応答でリダイレクトされ、リダイレクト先APIのリソースが応答として返却される。</td></tr><tr><td>error</td></tr><tr><td>manual</td></tr><tr><td rowspan="3">credentials</td><td>include</td><td colspan="4" rowspan="2">Cookieが送られる。</td></tr><tr><td>same-origin</td></tr><tr><td>omit</td><td colspan="2">Cookieが送られない。</td><td colspan="2">Cookieが送られる。</td></tr><tr><td colspan="2">302によるリダイレクト時にSet-Cookieヘッダが存在した場合</td><td colspan="4">Cookieが正しく設定される。</td></tr><tr><td colspan="2">レスポンスヘッダーで2つのSet-Cookieを受け取った場合</td><td colspan="4">2つとも正しく設定される。</td></tr></tbody></table><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="axios">axios<a class="hash-link" href="#axios" title="見出しへの直接リンク">​</a></h4><table><thead><tr><th rowspan="2" colspan="2" width="28%">検証内容</th><th colspan="2" width="36%">Android</th><th colspan="2" width="36%">iPhone</th></tr><tr><th width="18%">実機</th><th width="18%">エミュレータ</th><th width="18%">実機</th><th width="18%">シミュレータ</th></tr></thead><tbody><tr><td rowspan="3">maxRedirects</td><td>0</td><td rowspan="3" colspan="4">302応答でリダイレクトされ、リダイレクト先APIのリソースが応答として返却される。</td></tr><tr><td>1</td></tr><tr><td>2</td></tr><tr><td rowspan="2">withCredentials</td><td>true</td><td colspan="4">Cookieが送られる。</td></tr><tr><td>false</td><td colspan="2">Cookieが送られない。</td><td colspan="2">Cookieが送られる。</td></tr><tr><td colspan="2">302によるリダイレクト時にSet-Cookieヘッダが存在した場合</td><td colspan="4">Cookieが正しく設定される。</td></tr><tr><td colspan="2">レスポンスヘッダーで2つのSet-Cookieを受け取った場合</td><td colspan="4">2つとも正しく設定される。</td></tr></tbody></table><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="検証結果の考察">検証結果の考察<a class="hash-link" href="#検証結果の考察" title="見出しへの直接リンク">​</a></h4><p>以下、検証結果の考察です。</p><p><code>redirect</code>オプションについて、どのオプションを指定しても302応答でリダイレクトされ、リダイレクト先APIのリソースが返ってきました。
<code>redirect</code>オプションは機能していないようです。
<code>maxRedirects</code>オプションも同様に機能していないようです。</p><p><code>credentials</code>オプションについて、<code>credentials:include</code>、<code>credentials:same-origin</code>ではCookieがバックエンドに送信されました。
一方で<code>credentials:omit</code>を指定すると、AndroidはCookieが送信されませんでしたが（想定される動作）、iOSは送信されました。
<code>withCredentials</code>オプションも同様の動作に見えます。</p><p>Androidで同じ名前のヘッダーを持つ場合の問題を検証するため、リダイレクト元APIから<code>Set-Cookie</code>ヘッダを2つ返しましたが、Android、iOS共にCookie値が正しく設定されました。
<a href="https://github.com/facebook/react-native/commit/1a33607" target="_blank" rel="noopener noreferrer">こちら</a>で問題が解決されたようです。</p><p>リダイレクトされた時に<code>Set-Cookie</code>ヘッダが存在しても、Cookieは正しく設定されました。</p><p>これらのことから、報告されていた問題のうち後者2つについては既に解消しています。
fetchの一部オプションに対応していない問題については、報告のとおり、<a href="https://developer.mozilla.org/ja/docs/Web/API/Fetch_API" target="_blank" rel="noopener noreferrer">Fetch APIの仕様</a>通りに実装が提供されているわけではなさそうです。
このアプリでは、バックエンドAPIのリダイレクトを無視したいケースがないので、redirectオプションやmaxRedirectオプションの影響は受けません。
credentialsオプションやwithCredentialsオプションについても、モバイルアプリという特性上クロスオリジンを意識する必要はありません。リクエスト先のドメインによって発行されたCookieを送信できれば問題ないでしょう。
よって、Cookie-basedの認証を採用して開発を進めても問題ないと判断します。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_13-_"><span class="theme-last-updated"><b><time datetime="2022-01-12T02:09:31.000Z">2022/1/12</time></b>に<!-- -->最終更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントのナビゲーション"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-006-logging"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">ログ出力の方針</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#要約" class="table-of-contents__link toc-highlight">要約</a></li><li><a href="#コンテキスト" class="table-of-contents__link toc-highlight">コンテキスト</a></li><li><a href="#議論" class="table-of-contents__link toc-highlight">議論</a><ul><li><a href="#認証手段" class="table-of-contents__link toc-highlight">認証手段</a></li><li><a href="#サインアップ" class="table-of-contents__link toc-highlight">サインアップ</a></li><li><a href="#ログイン" class="table-of-contents__link toc-highlight">ログイン</a></li><li><a href="#ログアウト" class="table-of-contents__link toc-highlight">ログアウト</a></li><li><a href="#想定される脅威攻撃手法とその対応" class="table-of-contents__link toc-highlight">想定される脅威（攻撃手法）とその対応</a></li><li><a href="#想定される課題とその対応" class="table-of-contents__link toc-highlight">想定される課題とその対応</a></li></ul></li><li><a href="#決定" class="table-of-contents__link toc-highlight">決定</a></li><li><a href="#付録" class="table-of-contents__link toc-highlight">付録</a><ul><li><a href="#react-nativeでcookieを扱う場合の懸念点について" class="table-of-contents__link toc-highlight">React NativeでCookieを扱う場合の懸念点について</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contents</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mobile-app-crib-notes/reference">Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">React Native</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mobile-app-crib-notes/react-native/learn">Learn</a></li><li class="footer__item"><a class="footer__link-item" href="/mobile-app-crib-notes/react-native/santoku">Example App</a></li><li class="footer__item"><a class="footer__link-item" href="/mobile-app-crib-notes/react-native/common-pitfalls">Pitfalls</a></li></ul></div><div class="col footer__col"><div class="footer__title">Related Work</div><ul class="footer__items"><li class="footer__item"><a href="https://fintan.jp" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Fintan<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://fintan.jp/?p=5952" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>SPA + REST API構成のサービス開発リファレンス<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://fintan.jp/?tag=react-native" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Fintan » React Native<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div class="no-content">
<div class="copyright">
  ドキュメントは、<a rel="license" href="https://fintan.jp/?page_id=201" target="_blank">Fintan コンテンツ 使用許諾条項</a>の下に提供されており、コードサンプルは<a rel="license" href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache 2.0 License</a>の下に提供されています。
</div>
<div class="supplementary">
  <a href="/mobile-app-crib-notes/terms-of-use/" class="footer__link-item">当サイトのご利用にあたって</a>
  <a href="/mobile-app-crib-notes/trademark/" class="footer__link-item">商標について</a>
</div>
</div>
</div></div></div></footer></div>
<script src="/mobile-app-crib-notes/assets/js/runtime~main.0aa8e411.js"></script>
<script src="/mobile-app-crib-notes/assets/js/main.f45db73b.js"></script>
</body>
</html>