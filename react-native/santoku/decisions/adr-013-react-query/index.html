<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-react-native/santoku/decisions/adr-013-react-query" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">React Queryを用いた開発方針 | Fintan » Mobile App Development</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://fintan-contents.github.io/mobile-app-crib-notes/react-native/santoku/decisions/adr-013-react-query"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="React Queryを用いた開発方針 | Fintan » Mobile App Development"><meta data-rh="true" name="description" content="Status: Accepted"><meta data-rh="true" property="og:description" content="Status: Accepted"><link data-rh="true" rel="icon" href="/mobile-app-crib-notes/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://fintan-contents.github.io/mobile-app-crib-notes/react-native/santoku/decisions/adr-013-react-query"><link data-rh="true" rel="alternate" href="https://fintan-contents.github.io/mobile-app-crib-notes/react-native/santoku/decisions/adr-013-react-query" hreflang="ja"><link data-rh="true" rel="alternate" href="https://fintan-contents.github.io/mobile-app-crib-notes/react-native/santoku/decisions/adr-013-react-query" hreflang="x-default"><script src="https://plausible.io/js/script.js" defer="defer" data-domain="fintan-contents.github.io,all.fintan"></script><link rel="stylesheet" href="/mobile-app-crib-notes/assets/css/styles.b068789d.css">
<link rel="preload" href="/mobile-app-crib-notes/assets/js/runtime~main.c82dcb28.js" as="script">
<link rel="preload" href="/mobile-app-crib-notes/assets/js/main.1abe714a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://fintan.jp" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/mobile-app-crib-notes/img/fintan-logo.jpg" alt="Fintan Mobile App" class="themedImage_ToTc themedImage--light_HNdA"><img src="/mobile-app-crib-notes/img/fintan-logo.jpg" alt="Fintan Mobile App" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a class="navbar__item navbar__link" href="/mobile-app-crib-notes/">Home</a><a class="navbar__item navbar__link" href="/mobile-app-crib-notes/reference">Reference</a><a class="navbar__item navbar__link" href="/mobile-app-crib-notes/distribution">Distribution</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">React Native</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/mobile-app-crib-notes/react-native/learn">Learn</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/mobile-app-crib-notes/react-native/santoku">Example App</a></li><li><a class="dropdown__link" href="/mobile-app-crib-notes/react-native/common-pitfalls">Trouble shooting</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/fintan-contents/mobile-app-crib-notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a href="https://fintan.jp" target="_blank" rel="noopener noreferrer" tabindex="-1" class="sidebarLogo_isFc"><img src="/mobile-app-crib-notes/img/fintan-logo.jpg" alt="Fintan Mobile App" class="themedImage_ToTc themedImage--light_HNdA"><img src="/mobile-app-crib-notes/img/fintan-logo.jpg" alt="Fintan Mobile App" class="themedImage_ToTc themedImage--dark_i4oU"></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/mobile-app-crib-notes/react-native/santoku">はじめに</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/mobile-app-crib-notes/react-native/santoku/requirements">Requirements</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/mobile-app-crib-notes/react-native/santoku/application-architecture">Application Architecture</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/mobile-app-crib-notes/react-native/santoku/test-planning">Test Planning</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/mobile-app-crib-notes/react-native/santoku/design">Design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/mobile-app-crib-notes/react-native/santoku/development">Development</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/mobile-app-crib-notes/react-native/santoku/maintenance">Maintenance</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/mobile-app-crib-notes/react-native/santoku/decisions">Decision Records</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions">目次</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-001-error-handling">グローバルエラーハンドリング</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-002-http-api-libraries">HTTP通信で使用するライブラリ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-003-http-api-error-handling">HTTP API通信で発生するエラーのハンドリング</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-004-deep-link">ディープリンクの実現方式（廃止）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-005-message">メッセージ管理の方針</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-006-logging">ログ出力の方針</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-007-auth">認証方式の方針</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-008-push-notification">プッシュ通知方式の方針</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-009-push-notification-fcm">FCMを用いたプッシュ通知の管理方針</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-010-push-notification-contents">プッシュ通知の内容に関する方針</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-011-cache-management">キャッシュの取り扱いに関する方針</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-012-http-api">HTTP API通信に関する方針</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-013-react-query">React Queryを用いた開発方針</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-014-ui-libraries">UIライブラリの選定</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-015-android-head-up-notification">Androidのヘッドアップ通知</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-016-forced-app-updates">強制アプリアップデート</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-017-map-view-library">地図表示ライブラリ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-018-deep-link">ディープリンクの実現方式</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-019-deep-link-navigation">ディープリンク受信時の画面遷移</a></div></li></ul></li></ul></nav><button type="button" title="サイドバーを隠す" aria-label="サイドバーを隠す" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>React Queryを用いた開発方針</h1></header><p>Status: Accepted</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="要約">要約<a href="#要約" class="hash-link" aria-label="要約 への直接リンク" title="要約 への直接リンク">​</a></h2><p>React Queryを用いた開発方針について、検討の結果次の通りとします。</p><ul><li>React Queryのデフォルト設定について、「クエリ失敗時のリトライをしない」ように変更し、それ以外はデフォルトのままとする</li><li>古いデータが表示されることによるユーザの混乱を防ぐ為、データ更新後に古くなったキャッシュデータを破棄する</li><li>二重送信防止のため、ユーザ操作に応じて操作を制限する</li><li>共通のエラー処理は、React QueryのGlobal callbacksを利用して実現する</li><li>HTTPステータスコード401応答時のセッション再接続は、axiosのInterceptorsなどの機能を利用して実現する</li><li>ページネーションや無限スクロールに対応したバックエンドAPIの仕様をアプリ内で統一する</li><li>クライアントコードの自動生成ツールにOrvalを採用する</li><li>クエリキーの命名ルールはOrvalが自動生成したものに従う</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="コンテキスト">コンテキスト<a href="#コンテキスト" class="hash-link" aria-label="コンテキスト への直接リンク" title="コンテキスト への直接リンク">​</a></h2><p>React Queryは非常に豊富な機能を用意しています。
これらの機能を活用することで、HTTP API通信を実現する上での様々な課題に対応できます。
しかしながら、全ての課題が解決するわけではありません。
例えば次にあげる課題については、アプリの特性に応じてそれぞれ方針を決める必要があります。</p><ul><li>React Queryのデフォルトオプションは何を設定すべきか</li><li>データ更新などにより古くなったキャッシュデータをどう扱うか</li><li>二重送信をどのように防止すべきか</li><li>通信エラーをどのようにハンドリングすべきか</li><li>ページネーションや無限スクロールをどのように実現するか</li><li>クライアントコードの自動生成ツールは何を使うか</li><li>クエリキーの命名ルールをどうするか</li></ul><p>ここでは、上記課題解消を目的として、React Queryを用いた開発方針について検討します。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="議論">議論<a href="#議論" class="hash-link" aria-label="議論 への直接リンク" title="議論 への直接リンク">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="react-queryのデフォルトオプション">React Queryのデフォルトオプション<a href="#react-queryのデフォルトオプション" class="hash-link" aria-label="React Queryのデフォルトオプション への直接リンク" title="React Queryのデフォルトオプション への直接リンク">​</a></h3><p>React Queryには多数のオプションが用意されています。
これらのオプションは、全てのクエリやミューテーションに適用するデフォルト値を設定することが出来、かつクエリ・ミューテーション毎にその値を上書きできます。
ここでは、これらいくつかのオプションについて、このアプリの特性に応じた設定値を検討します。
特に、React Query公式ドキュメントの<a href="https://react-query.tanstack.com/guides/important-defaults" target="_blank" rel="noopener noreferrer">Important Defaults</a>で示されるオプションについては、デフォルトのままで問題ないかを注意深く検討します。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="クエリのデフォルトオプション">クエリのデフォルトオプション<a href="#クエリのデフォルトオプション" class="hash-link" aria-label="クエリのデフォルトオプション への直接リンク" title="クエリのデフォルトオプション への直接リンク">​</a></h4><p>クエリのデフォルトオプションについて、検討結果は次の通りです。</p><table><thead><tr><th align="left">オプション</th><th align="left">検討結果</th></tr></thead><tbody><tr><td align="left">queryFn</td><td align="left"><a href="https://react-query.tanstack.com/guides/default-query-function" target="_blank" rel="noopener noreferrer">Default Query Function</a>で紹介されているとおり、デフォルトのクエリ関数を定義出来ます。これにより、SWRのようなシンプルな記述を実現することが出来ます。しかしながら、このアプリではOpenAPI仕様からソースコードを自動生成することにより、REST APIとの整合性や開発効率性の向上を図ります。その為、このオプションは利用しません。</td></tr><tr><td align="left">retry</td><td align="left">クエリ失敗時のリトライ回数です。<a href="https://react-query.tanstack.com/guides/important-defaults" target="_blank" rel="noopener noreferrer">Important Defaults</a>で示されるとおり、デフォルト値は3です。このアプリでは、<a href="/mobile-app-crib-notes/react-native/santoku/application-architecture/http-api/http-api-error-handling#http-api%E9%80%9A%E4%BF%A1%E3%81%AE%E3%83%AA%E3%83%88%E3%83%A9%E3%82%A4">HTTP API 通信のリトライ</a>に従いリトライはユーザ自身の判断とします。<code>false</code>をデフォルト値として設定します（リトライしません）。</td></tr><tr><td align="left">retryOnMount</td><td align="left">マウント時にリトライするかどうかを示します。デフォルト値は<code>true</code>です。デフォルト値のままとします。</td></tr><tr><td align="left">retryDelay</td><td align="left">リトライ時の遅延間隔を示します。デフォルトでは、リトライの度に指数関数的に待ち時間が増えていきます（Exponential Backoff）。デフォルト値のままとします。</td></tr><tr><td align="left">staleTime</td><td align="left">クエリが「新しい」ものから「古くなる」までの期間です。クエリが「新しい」限り、クエリは取得済みのデータを返すため、ネットワークリクエストは発生しません。クエリが「古い」場合、クエリは取得済みのデータを返し、特定の条件下にてバックグラウンドで再フェッチします。<a href="https://react-query.tanstack.com/guides/important-defaults" target="_blank" rel="noopener noreferrer">Important Defaults</a>で示されるとおり、デフォルト値は0です（フェッチ後すぐ古くなる）。デフォルト値のままとし、必要に応じて各クエリ毎に個別で設定することとします。</td></tr><tr><td align="left">cacheTime</td><td align="left">未使用なクエリを削除するまでの期間です。クエリを使用するすべてのコンポーネントがアンマウントされると、そのクエリは未使用となります。<a href="https://react-query.tanstack.com/guides/important-defaults" target="_blank" rel="noopener noreferrer">Important Defaults</a>で示されるとおり、デフォルト値は5分です。デフォルト値のままとし、必要に応じて各クエリ毎に個別で設定することとします。</td></tr><tr><td align="left">refetchOnMount</td><td align="left">マウント時に再フェッチするかどうかを示します。デフォルト（<code>true</code>）では、データが古くなっている場合に再フェッチします。デフォルト値のままとします。</td></tr><tr><td align="left">refetchOnWindowFocus</td><td align="left">ウィンドウフォーカス時に再フェッチするかどうかを示します。デフォルト（<code>true</code>）では、データが古くなっている場合に再フェッチします。デフォルト値のままとします。</td></tr><tr><td align="left">refetchOnReconnect</td><td align="left">再接続時に再フェッチするかどうかを示します。デフォルト（<code>true</code>）では、データが古くなっている場合に再フェッチします。デフォルト値のままとします。</td></tr><tr><td align="left">structuralSharing</td><td align="left">デフォルト（<code>true</code>）では、クエリ結果のデータの中身が変更されていない場合、データの参照が変更されません。これによりアプリのパフォーマンス向上が望めます。デフォルト値のままとしますが、クエリ結果の比較がパフォーマンス上の問題を引き起こす場合は、個別で<code>false</code>に設定することにします。</td></tr></tbody></table><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ミューテーションのデフォルトオプション">ミューテーションのデフォルトオプション<a href="#ミューテーションのデフォルトオプション" class="hash-link" aria-label="ミューテーションのデフォルトオプション への直接リンク" title="ミューテーションのデフォルトオプション への直接リンク">​</a></h4><p>ミューテーションのデフォルトオプションについて、検討結果は次の通りです。</p><table><thead><tr><th align="left">オプション</th><th align="left">検討結果</th></tr></thead><tbody><tr><td align="left">retry</td><td align="left">ミューテーション失敗時のリトライ回数です。デフォルト値は0です。デフォルト値のままとします。</td></tr><tr><td align="left">retryDelay</td><td align="left">リトライ時の遅延間隔を示します。デフォルトでは、リトライの度に指数関数的に待ち時間が増えていきます（Exponential Backoff）。そもそもリトライはしないので、デフォルト値のままとします。</td></tr></tbody></table><p>ミューテーションにおいては、検討の結果全てデフォルトのままで問題ないと判断しました。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="デフォルトオプションの設定例">デフォルトオプションの設定例<a href="#デフォルトオプションの設定例" class="hash-link" aria-label="デフォルトオプションの設定例 への直接リンク" title="デフォルトオプションの設定例 への直接リンク">​</a></h4><p>検討結果を反映したデフォルトオプションの設定例は次の通りです。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> queryClient </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">QueryClient</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    defaultOptions</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      queries</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        retry</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="データ更新時のキャッシュの扱いについて">データ更新時のキャッシュの扱いについて<a href="#データ更新時のキャッシュの扱いについて" class="hash-link" aria-label="データ更新時のキャッシュの扱いについて への直接リンク" title="データ更新時のキャッシュの扱いについて への直接リンク">​</a></h3><p><code>useQuery</code>を呼びだすと、取得済みのデータがあればそれを返し、必要に応じてクエリをバックグラウンドで再フェッチします。
そして再フェッチ完了後に新しいデータで画面を更新します。
再フェッチ中に取得済みデータを表示する動作は、頻繁なローディングインジケーターの表示を抑えUX向上に役立ちます。
一方で、更新後も一時的に古いデータが見えるため、ユーザの混乱を引き起こす可能性があります。</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>注記</div><div class="admonitionContent_S0QG"><p>詳細は<a href="https://react-query.tanstack.com/guides/caching" target="_blank" rel="noopener noreferrer">Caching Examples</a>を参照してください。</p></div></div><p>React Queryの公式ドキュメントでは、更新後にデータを最新化する2つの方法が提示されています。</p><ol><li><a href="https://react-query.tanstack.com/guides/invalidations-from-mutations" target="_blank" rel="noopener noreferrer">Invalidation from Mutations</a></li><li><a href="https://react-query.tanstack.com/guides/updates-from-mutation-responses" target="_blank" rel="noopener noreferrer">Updates from Mutation Responses</a></li></ol><p>1つめは、ミューテーション成功時にキャッシュしたクエリを無効にする方法です。
これにより、対象となるクエリはバックグラウンドで再フェッチを試みます。
この方法の場合、再フェッチが終了するまで一時的に古いデータが表示されるため、ユーザの混乱を引き起こす可能性があります。</p><p>2つめは、ミューテーション成功時にレスポンスの値でキャッシュデータを更新する方法です。
パフォーマンスに優れた方法ですが、レスポンスで更新後の値を取得できることが前提となります。
また、やや実装が複雑なものとなります。</p><p>このアプリにおいては、更新後に古いデータが見えることなく、かつできるだけシンプルな方法でデータを最新化したいです。
そこで、ミューテーション成功時に再フェッチが必要なクエリのキャッシュデータを破棄することで、古いデータを表示させない方針とします。</p><p>コード例は次の通りです。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> mutation </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">useMutation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">addTodo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">onSuccess</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    queryClient</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">resetQueries</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;todos&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>このコードでは、新しいタスクを追加した後にToDoリストのキャッシュデータを破棄します。
これにより再フェッチ中は画面にローディングインジケーターが表示されることになりますが、古いデータが表示されることはありません。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二重送信防止について">二重送信防止について<a href="#二重送信防止について" class="hash-link" aria-label="二重送信防止について への直接リンク" title="二重送信防止について への直接リンク">​</a></h3><p>Webアプリケーション同様に、モバイルアプリにおいても二重送信を防ぐ仕組みが必要です。
しかし、商品購入のような重要処理の二重実行を完全に防ぐには、バックエンド側での対策（トークンを用いたチェックなど）が必要です。
バックエンド側の対策はここでの検討範囲外とし、ユーザの操作ミスによる二重送信防止について検討します。</p><p>対策として、次の案があります。</p><ul><li>通信中も一切の操作を制限しない</li><li>通信中は対象ボタンのみを押下不可</li><li>通信中は対象画面全体を操作不可（画面遷移は可能）</li><li>通信中はアプリ全体を操作不可（画面遷移は不可能）</li></ul><p>下の案にいくほどユーザ操作が制限されるため、ユーザビリティが落ちます。
一方で、下の案ほどユーザ操作を制限できるため、予期せぬ操作への考慮が不要となります。</p><p>このアプリにおいては、更新時の操作制限はそれほどユーザビリティに影響を与えないと判断し、次の方針とします。</p><ul><li>画面の初期ロードなど、ユーザ操作に直接起因しない通信については、一切の操作を制限しない</li><li>検索ボタン押下など、ユーザ操作に起因して発生した通信については、対象ボタンのみを押下不可とする</li><li>ユーザ設定更新のような再設定可能な更新操作については、対象ボタンのみを押下不可とする</li><li>商品購入のような重要操作については、アプリ全体を操作不可とする</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="エラーハンドリング">エラーハンドリング<a href="#エラーハンドリング" class="hash-link" aria-label="エラーハンドリング への直接リンク" title="エラーハンドリング への直接リンク">​</a></h3><p>エラーハンドリングについては、<a href="/mobile-app-crib-notes/react-native/santoku/application-architecture/http-api/http-api-error-handling">HTTP API通信で発生するエラーのハンドリング</a>に従います。
共通的なエラーハンドリング処理は、個別で実装せず共通化を検討します。
また、HTTPステータスコード401が返却された場合の通信リトライについても処理の共通化を検討します。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="エラーハンドリングの共通化">エラーハンドリングの共通化<a href="#エラーハンドリングの共通化" class="hash-link" aria-label="エラーハンドリングの共通化 への直接リンク" title="エラーハンドリングの共通化 への直接リンク">​</a></h4><p><code>useQuery</code>のクエリオプションである<code>onError</code>にハンドラ関数を設定することで、クエリで発生したエラーをハンドリングできます。
また、<code>QueryClient</code>のデフォルトオプションに設定することで、各クエリ毎にハンドラ関数を設定する手間が省けます。
しかしならが、上記方法だと次の課題が発生します。</p><ul><li>個別にエラー処理を追加したいなどの理由により<code>useQuery</code>の<code>onError</code>に独自のハンドラ関数を設定すると、<code>QueryClient</code>のデフォルトオプションに設定したものが上書きされる</li><li>同じクエリを使用した画面が複数存在すると、エラー処理も複数回実行される（例えば同じトーストが複数表示される）</li></ul><p>そこで、共通のエラーハンドラ関数は<code>QueryCache</code>の<code>onError</code>に設定します。
そうすることで、上記に挙げた課題が解決します。
ミューテーションについても同様の対策とします。
詳細は次のドキュメントを参照してください。</p><ul><li><a href="https://react-query.tanstack.com/reference/QueryCache#global-callbacks" target="_blank" rel="noopener noreferrer">QueryCache - Global callbacks</a></li><li><a href="https://react-query.tanstack.com/reference/MutationCache#global-callbacks" target="_blank" rel="noopener noreferrer">MutationCache - Global callbacks</a></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="httpステータスコード401返却時の通信リトライ">HTTPステータスコード401返却時の通信リトライ<a href="#httpステータスコード401返却時の通信リトライ" class="hash-link" aria-label="HTTPステータスコード401返却時の通信リトライ への直接リンク" title="HTTPステータスコード401返却時の通信リトライ への直接リンク">​</a></h4><p>HTTPステータスコード401が返却された場合、新しいセッションIDを再取得しリトライする機能が必要です。
React Queryにも通信リトライ機能は用意されておりますが、一時的なネットワークエラーに対応するものであり、セッションの再接続などを実現するものではありません。そこで、axiosのInterceptorsなどの機能を利用してセッションの再接続を実現します。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ページネーションや無限スクロールへの対応">ページネーションや無限スクロールへの対応<a href="#ページネーションや無限スクロールへの対応" class="hash-link" aria-label="ページネーションや無限スクロールへの対応 への直接リンク" title="ページネーションや無限スクロールへの対応 への直接リンク">​</a></h3><p>リモートにある膨大なデータからアプリ内で必要なデータのみを取得し表示するには、ページネーションや無限スクロールへの対応が必要です。
React Queryにはページネーションや無限スクロールの仕組みが用意されているのでそれに従います。</p><ul><li><a href="https://react-query.tanstack.com/guides/paginated-queries" target="_blank" rel="noopener noreferrer">Paginated / Lagged Queries</a></li><li><a href="https://react-query.tanstack.com/guides/infinite-queries" target="_blank" rel="noopener noreferrer">Infinite Queries</a></li></ul><p>ここでは、これらを実現するために必要なバックエンドAPIの仕様について検討し、アプリ内で統一することとします。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ページネーション">ページネーション<a href="#ページネーション" class="hash-link" aria-label="ページネーション への直接リンク" title="ページネーション への直接リンク">​</a></h4><p>ページネーションを実現する為には、バックエンドAPIのリクエスト項目にページ番号が必要です。
さらにはページサイズやソート順を指定できるのが望ましいです。
また、総ページ数を表示するにはレスポンスにその値が必要です。</p><p>ページネーションを実現するにあたり、標準的なAPI仕様は見当たりませんでした。
そこで、<a href="https://docs.spring.io/spring-data/rest/docs/current/reference/html/#paging-and-sorting" target="_blank" rel="noopener noreferrer">Spring Data REST Reference Guide の 5. Paging and Sorting</a>を参考に次の通りとします。</p><table><thead><tr><th align="left">URLクエリパラメータ</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">page</td><td align="left">開始ページ番号</td></tr><tr><td align="left">size</td><td align="left">ページサイズ</td></tr><tr><td align="left">sort</td><td align="left">ソート項目</td></tr></tbody></table><p>総ページ数や全要素数は、HTTPボディの項目として返却します。</p><table><thead><tr><th align="left">HTTPボディの項目</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">content</td><td align="left">レスポンスデータ</td></tr><tr><td align="left">empty</td><td align="left">ページが0件かどうか</td></tr><tr><td align="left">first</td><td align="left">最初のページかどうか</td></tr><tr><td align="left">last</td><td align="left">最後のページかどうか</td></tr><tr><td align="left">number</td><td align="left">何ページ目か</td></tr><tr><td align="left">size</td><td align="left">ページサイズ</td></tr><tr><td align="left">sort</td><td align="left">ソート項目</td></tr><tr><td align="left">numberOfElements</td><td align="left">ページに含まれる要素の件数</td></tr><tr><td align="left">pageable</td><td align="left">リクエストで指定した<code>page</code>、<code>size</code>、<code>sort</code>を保持するオブジェクト</td></tr><tr><td align="left">totalElements</td><td align="left">全要素数</td></tr><tr><td align="left">totalPages</td><td align="left">総ページ数</td></tr></tbody></table><p>それぞれの項目は、ページネーションを実現するすべてのAPIに用意する必要はなく、APIごとに必要な項目を取捨選択することとします。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="無限スクロール">無限スクロール<a href="#無限スクロール" class="hash-link" aria-label="無限スクロール への直接リンク" title="無限スクロール への直接リンク">​</a></h4><p>React Queryの<code>useInfiniteQuery</code>フックは、読み込んだページのキャッシュデータを配列（<code>data.pages</code>）で保持します。
追加読込みをしたレスポンスデータは、その配列にページとして追加されます。
無限スクロールのよくある例として、アプリはそのキャッシュデータを1つの画面に全て表示します。
その為、ページネーションAPIの仕様を無限スクロールに利用した場合、次の恐れがあります。</p><ul><li>読込み済みページの範囲でデータの追加が行われると、後続の追加読込みで重複されたデータが読み込まれる</li><li>読込み済みページの範囲でデータの削除が行われると、表示されないデータが出る</li></ul><p>そうした事象を避けるため、無限スクロールのAPI仕様はページネーションのそれとは別で定義します。</p><p>無限スクロールを実現する為には、カーソル（ソート可能なID）が必要です。
さらには最大取得件数を指定できるのが望ましいです。
また、レスポンスには次のデータ位置を指し示すカーソルが必要です。</p><p>無限スクロールを実現するにあたり、標準的なAPI仕様は見当たりませんでした。
そこで、<a href="https://react-query.tanstack.com/guides/infinite-queries" target="_blank" rel="noopener noreferrer">Infinite Queries</a>のサンプルコードを参考に次の通りとします。</p><table><thead><tr><th align="left">URLクエリパラメータ</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">cursor</td><td align="left">カーソル</td></tr><tr><td align="left">limit</td><td align="left">最大取得件数</td></tr></tbody></table><p>データ位置を指し示すカーソルは、HTTPボディの項目として返却します。</p><table><thead><tr><th align="left">HTTPボディの項目</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">content</td><td align="left">レスポンスデータ</td></tr><tr><td align="left">hasPrevious</td><td align="left">前のデータがあるかどうか</td></tr><tr><td align="left">previousCursor</td><td align="left">前のカーソル</td></tr><tr><td align="left">hasNext</td><td align="left">次のデータがあるかどうか</td></tr><tr><td align="left">nextCursor</td><td align="left">次のカーソル</td></tr></tbody></table><p>それぞれの項目は、無限スクロールを実現するすべてのAPIに用意する必要はなく、APIごとに必要な項目を取捨選択することとします。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="クライアントコードの自動生成について">クライアントコードの自動生成について<a href="#クライアントコードの自動生成について" class="hash-link" aria-label="クライアントコードの自動生成について への直接リンク" title="クライアントコードの自動生成について への直接リンク">​</a></h3><p>OpenAPI仕様があると、そこからクライアントコードを自動生成できます。
これは生産性向上、および品質向上に役立ちます。
このアプリにおいてもバックエンドAPIのOpenAPI仕様が用意されています。
そこで、ここではクライアントコードの自動生成ツールについて検討します。</p><p>React Queryを使う場合の自動生成ツールとしては、次の候補があります。</p><ul><li><a href="https://github.com/OpenAPITools/openapi-generator" target="_blank" rel="noopener noreferrer">OpenAPI Generator</a></li><li><a href="https://orval.dev/" target="_blank" rel="noopener noreferrer">Orval</a></li></ul><p>それぞれにおいて比較検討しました。
比較結果は次のとおりです。</p><table><thead><tr><th align="left"></th><th align="left">OpenAPI Generator</th><th align="left">Orval</th></tr></thead><tbody><tr><td align="left">ライセンス</td><td align="left">Apache License 2.0</td><td align="left">MIT License</td></tr><tr><td align="left">開発母体</td><td align="left">OpenAPI Tools</td><td align="left">個人</td></tr><tr><td align="left">人気</td><td align="left">11k star(GitHub)</td><td align="left">367 star(GitHub)</td></tr><tr><td align="left">機能</td><td align="left">△</td><td align="left">〇</td></tr><tr><td align="left">実績</td><td align="left">◎</td><td align="left">△</td></tr><tr><td align="left">生成コードの品質</td><td align="left">〇</td><td align="left">◎</td></tr></tbody></table><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ライセンス">ライセンス<a href="#ライセンス" class="hash-link" aria-label="ライセンス への直接リンク" title="ライセンス への直接リンク">​</a></h4><p>OpenAPI GeneratorのライセンスはApache License 2.0です。
OrvalのライセンスはMIT Licenseです。
いずれも商用利用において問題ありません。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="開発母体">開発母体<a href="#開発母体" class="hash-link" aria-label="開発母体 への直接リンク" title="開発母体 への直接リンク">​</a></h4><p>開発母体はOpenAPI GeneratorがOpenAPI Toolsという組織での開発に対し、Orvalは個人が開発しています。
OpenAPI Generatorのほうが開発母体として安定性を感じます。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="人気">人気<a href="#人気" class="hash-link" aria-label="人気 への直接リンク" title="人気 への直接リンク">​</a></h4><p>GitHubのスターで確認する限り、OpenAPI Generatorのほうが圧倒的に知名度があります。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="機能">機能<a href="#機能" class="hash-link" aria-label="機能 への直接リンク" title="機能 への直接リンク">​</a></h4><p><a href="https://openapi-generator.tech/docs/generators/" target="_blank" rel="noopener noreferrer">Generators List</a>にあるとおり、OpenAPI GeneratorはFetch APIやaxiosを使用したクライアントコードを自動生成できます。
一方で、まだReact Queryは対応していないようです。
そのため、API毎に<code>useQuery</code>を使用したカスタムフックは用意する場合、別途実装する必要があります。
OrvalはReact Queryにも対応しており、API毎に<code>useQuery</code>を使用したカスタムフックが自動生成されます。
このアプリに限定するのであれば、Orvalのほうが必要な機能は揃っています。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="実績">実績<a href="#実績" class="hash-link" aria-label="実績 への直接リンク" title="実績 への直接リンク">​</a></h4><p>定量的な数値は抑えておりませんが、OpenAPI Generatorを用いた開発実績は多数あります。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="生成コードの品質">生成コードの品質<a href="#生成コードの品質" class="hash-link" aria-label="生成コードの品質 への直接リンク" title="生成コードの品質 への直接リンク">​</a></h4><p>単純なToDoアプリのOpenAPI仕様を用いてクライアントコードを生成し、その品質を比較検討しました。</p><table><thead><tr><th align="left"></th><th align="left">OpenAPI Generator</th><th align="left">Orval</th></tr></thead><tbody><tr><td align="left">コード（LOC）</td><td align="left">296</td><td align="left">116</td></tr><tr><td align="left">コメント（LOC）</td><td align="left">378</td><td align="left">59</td></tr><tr><td align="left">保守性</td><td align="left">△</td><td align="left">◎</td></tr></tbody></table><p>Orvalと比較すると、OpenAPI Generatorで生成したコードのステップ数は倍以上あります。
定性的な比較となりますが、OpenAPI GeneratorよりOrvalの生成コードのほうが読みやすいと感じました。
自動生成ツールが使えなくなったなどの理由で、手作業で生成コードを保守する必要性が将来的に出た場合、Orvalのほうが保守しやすいです。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="比較検討結果">比較検討結果<a href="#比較検討結果" class="hash-link" aria-label="比較検討結果 への直接リンク" title="比較検討結果 への直接リンク">​</a></h4><p>開発母体および実績を考慮するとOpenAPI Generatorが無難に感じます。
しかしながら、自動生成ツールそのものよりも、プロダクトコードに入る生成されたコードの品質が大切です。
機能面および生成コードの品質でOrvalは魅力的に見えます。
チーム内で議論した結果、React Queryへの対応、および生成コードの品質を主な理由としてOrvalを採用します。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="クエリキーの命名ルール">クエリキーの命名ルール<a href="#クエリキーの命名ルール" class="hash-link" aria-label="クエリキーの命名ルール への直接リンク" title="クエリキーの命名ルール への直接リンク">​</a></h3><p>React Queryはクエリキーに基づいてクエリキャッシュを管理します。
別々のクエリに誤って同じクエリキーを使用すると、思わぬ不具合が生じます。
こういったトラブルを避ける為、クエリキーの命名ルールを定める必要があります。</p><p>クエリキーの命名ルールとして、当初は次の3案を検討する予定でした。</p><ol><li>React Queryの公式ドキュメントで紹介されている<a href="https://tkdodo.eu/blog/effective-react-query-keys" target="_blank" rel="noopener noreferrer">Effective React Query Keys</a>に従いクエリキーを階層化（※1）して定義する</li><li>REST APIのURL内のPathとQuery部をクエリキーとして用いる</li><li>OpenAPIのoperationIdをクエリキーとして用いる</li></ol><p>（※1）<code>[&#x27;todos&#x27;, &#x27;list&#x27;]</code>や<code>[&#x27;todos&#x27;, &#x27;detail&#x27;, 1]</code>のような階層構造。</p><p>しかしながら、クエリキーもOrvalの自動生成コードに含まれます。
Orvalは案2の命名ルールでクエリキーを生成します。
特にその案で懸念はないため、クエリキーはOrvalの命名ルールを採用します。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="決定">決定<a href="#決定" class="hash-link" aria-label="決定 への直接リンク" title="決定 への直接リンク">​</a></h2><p>React Queryを用いる上での開発方針について検討しました。
このアプリでは、以下それぞれの課題に対して次の方針をとります。</p><table><thead><tr><th align="left">課題</th><th align="left">結論</th></tr></thead><tbody><tr><td align="left">React Queryのデフォルトオプションは何を設定すべきか</td><td align="left">クエリオプションの<code>retry</code>を<code>false</code>に設定する以外はデフォルトのままとします。</td></tr><tr><td align="left">データ更新などにより古くなったキャッシュデータをどう扱うか</td><td align="left">データ更新後に古くなったキャッシュデータを破棄することで古いデータを表示させません。</td></tr><tr><td align="left">二重送信防止</td><td align="left">ユーザ操作に応じて操作を制限します。</td></tr><tr><td align="left">エラーハンドリングの実装方針</td><td align="left">React QueryのGlobal callbacks機能を利用して共通エラー処理を実現します。また、axiosのInterceptorsなどの機能を利用してセッションの再接続を実現します。</td></tr><tr><td align="left">ページネーションや無限スクロールへの対応</td><td align="left">バックエンドAPIの仕様をアプリ内で統一します。</td></tr><tr><td align="left">クライアントコードの自動生成について</td><td align="left">開発母体および実績を主な理由としてOpenAPI Generatorを採用します。</td></tr><tr><td align="left">クエリキーの命名ルールをどうするか</td><td align="left">クエリキーの命名ルールはOrvalが自動生成したものに従います。</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated"><b><time datetime="2022-03-29T10:20:56.000Z">2022年3月29日</time></b>に<!-- -->最終更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-012-http-api"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">HTTP API通信に関する方針</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-014-ui-libraries"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">UIライブラリの選定</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#要約" class="table-of-contents__link toc-highlight">要約</a></li><li><a href="#コンテキスト" class="table-of-contents__link toc-highlight">コンテキスト</a></li><li><a href="#議論" class="table-of-contents__link toc-highlight">議論</a><ul><li><a href="#react-queryのデフォルトオプション" class="table-of-contents__link toc-highlight">React Queryのデフォルトオプション</a></li><li><a href="#データ更新時のキャッシュの扱いについて" class="table-of-contents__link toc-highlight">データ更新時のキャッシュの扱いについて</a></li><li><a href="#二重送信防止について" class="table-of-contents__link toc-highlight">二重送信防止について</a></li><li><a href="#エラーハンドリング" class="table-of-contents__link toc-highlight">エラーハンドリング</a></li><li><a href="#ページネーションや無限スクロールへの対応" class="table-of-contents__link toc-highlight">ページネーションや無限スクロールへの対応</a></li><li><a href="#クライアントコードの自動生成について" class="table-of-contents__link toc-highlight">クライアントコードの自動生成について</a></li><li><a href="#クエリキーの命名ルール" class="table-of-contents__link toc-highlight">クエリキーの命名ルール</a></li></ul></li><li><a href="#決定" class="table-of-contents__link toc-highlight">決定</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contents</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/mobile-app-crib-notes/reference">Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">React Native</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/mobile-app-crib-notes/react-native/learn">Learn</a></li><li class="footer__item"><a class="footer__link-item" href="/mobile-app-crib-notes/react-native/santoku">Example App</a></li><li class="footer__item"><a class="footer__link-item" href="/mobile-app-crib-notes/react-native/common-pitfalls">Trouble shooting</a></li></ul></div><div class="col footer__col"><div class="footer__title">Related Work</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://fintan.jp" target="_blank" rel="noopener noreferrer" class="footer__link-item">Fintan<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://fintan.jp/?p=5952" target="_blank" rel="noopener noreferrer" class="footer__link-item">SPA + REST API構成のサービス開発リファレンス<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://fintan.jp/blog-tag/react-native" target="_blank" rel="noopener noreferrer" class="footer__link-item">Fintan » React Native<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div class="no-content">
<div class="copyright">
  ドキュメントは、<a rel="license" href="https://fintan.jp/?page_id=201" target="_blank">Fintan コンテンツ 使用許諾条項</a>の下に提供されており、コードサンプルは<a rel="license" href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache 2.0 License</a>の下に提供されています。
</div>
<div class="supplementary">
  <a href="/mobile-app-crib-notes/terms-of-use/" class="footer__link-item">当サイトのご利用にあたって</a>
  <a href="/mobile-app-crib-notes/trademark/" class="footer__link-item">商標について</a>
</div>
</div>
</div></div></div></footer></div>
<script src="/mobile-app-crib-notes/assets/js/runtime~main.c82dcb28.js"></script>
<script src="/mobile-app-crib-notes/assets/js/main.1abe714a.js"></script>
</body>
</html>