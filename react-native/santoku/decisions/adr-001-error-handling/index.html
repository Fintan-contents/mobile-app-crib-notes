<!doctype html>
<html class="docs-version-current" lang="ja" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P630FEB9YY"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-P630FEB9YY",{})</script><title data-react-helmet="true">グローバルエラーハンドリング | Fintan » Mobile App Development</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://fintan-contents.github.io/mobile-app-crib-notes/react-native/santoku/decisions/adr-001-error-handling"><meta data-react-helmet="true" name="docusaurus_locale" content="ja"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="グローバルエラーハンドリング | Fintan » Mobile App Development"><meta data-react-helmet="true" name="description" content="Status: Accepted"><meta data-react-helmet="true" property="og:description" content="Status: Accepted"><link data-react-helmet="true" rel="shortcut icon" href="/mobile-app-crib-notes/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://fintan-contents.github.io/mobile-app-crib-notes/react-native/santoku/decisions/adr-001-error-handling"><link data-react-helmet="true" rel="alternate" href="https://fintan-contents.github.io/mobile-app-crib-notes/react-native/santoku/decisions/adr-001-error-handling" hreflang="ja"><link data-react-helmet="true" rel="alternate" href="https://fintan-contents.github.io/mobile-app-crib-notes/react-native/santoku/decisions/adr-001-error-handling" hreflang="x-default"><link rel="stylesheet" href="/mobile-app-crib-notes/assets/css/styles.9158aa34.css">
<link rel="preload" href="/mobile-app-crib-notes/assets/js/runtime~main.168a25f6.js" as="script">
<link rel="preload" href="/mobile-app-crib-notes/assets/js/main.195b5258.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">メインコンテンツまでスキップ</a></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://fintan.jp" target="_blank" rel="noopener noreferrer" class="navbar__brand"><img src="/mobile-app-crib-notes/img/fintan-logo-long.svg" alt="Fintan Mobile App" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/mobile-app-crib-notes/img/fintan-logo-long.svg" alt="Fintan Mobile App" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link" href="/mobile-app-crib-notes/">Home</a><a class="navbar__item navbar__link" href="/mobile-app-crib-notes/reference">Reference</a><a class="navbar__item navbar__link" href="/mobile-app-crib-notes/distribution">Distribution</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link">React Native</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/mobile-app-crib-notes/react-native/learn">Learn</a></li><li><a class="dropdown__link" href="/mobile-app-crib-notes/react-native/common-pitfalls">Pitfalls</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/fintan-contents/mobile-app-crib-notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo sidebarWithHideableNavbar_267A"><a href="https://fintan.jp" target="_blank" rel="noopener noreferrer" tabindex="-1" class="sidebarLogo_3h0W"><img src="/mobile-app-crib-notes/img/fintan-logo-long.svg" alt="Fintan Mobile App" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/mobile-app-crib-notes/img/fintan-logo-long.svg" alt="Fintan Mobile App" class="themedImage_1VuW themedImage--dark_hz6m"></a><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/mobile-app-crib-notes/react-native/santoku">はじめに</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Application Architecture</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Development</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Decision Records</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions">目次</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-001-error-handling">グローバルエラーハンドリング</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-002-http-api-libraries">HTTP通信で使用するライブラリ</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-003-http-api-error-handling">HTTP API通信で発生するエラーのハンドリング</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-004-deep-link">ディープリンクの実現方式</a></li></ul></li></ul></nav><button type="button" title="サイドバーを隠す" aria-label="サイドバーを隠す" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>グローバルエラーハンドリング</h1></header><p>Status: Accepted</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="要約"></a>要約<a class="hash-link" href="#要約" title="見出しへの直接リンク">#</a></h2><p>エラーのハンドリングに関する基本方針を以下とします。</p><ul><li>ユーザ操作や外部通信時などのイベントで発生するエラーにおいて、アプリを運用する上で想定可能なエラーについては個別にエラーをハンドリングする</li><li>未処理のエラーが発生した場合は、React Native Firebase Crashlyticsを使用してクラッシュログをFirebase Crashlyticsに送信する</li><li>未処理のエラーが発生した場合は、アプリをクラッシュさせる</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="コンテキスト"></a>コンテキスト<a class="hash-link" href="#コンテキスト" title="見出しへの直接リンク">#</a></h2><p>モバイルアプリでは、エラーが発生した場合にエラーの内容と、どのような手順で操作をすればエラーから回復できるかをユーザに伝える事が大切です。また、アプリがクラッシュしてしまった場合は、どのような操作でアプリがクラッシュしたかを特定することも重要です。</p><p>ここでは、React Nativeを使用したモバイルアプリにおいて、エラーの発生箇所毎にどのようなハンドリングを実施するべきかを検討します。なお、エラーが発生した場合にログを送信するプロダクトとして、<a href="https://firebase.google.com/docs/crashlytics?hl=ja" target="_blank" rel="noopener noreferrer">Firebase Crashlytics</a>を使用する前提<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>とします。Firebase Crashlyticsにログを送信するライブラリとしては<a href="https://rnfirebase.io/crashlytics/usage" target="_blank" rel="noopener noreferrer">React Native Firebase Crashlytics</a>を使用します。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="議論"></a>議論<a class="hash-link" href="#議論" title="見出しへの直接リンク">#</a></h2><p>React Nativeを使用したモバイルアプリでは、発生したエラーをハンドリングしないとアプリがクラッシュします。
アプリのクラッシュは、ユーザのアプリ離脱率が高くなる一因になります。そのため基本方針として、エラーの発生する可能性がある箇所については個別にエラーを捕捉してエラーの内容と復旧手順を適切にユーザに伝えます。また、必要に応じてFirebase Crashlyticsにエラーログを送信します。</p><p>ただし、エラーのハンドリング漏れが発生する可能性はないとは断言できないため、捕捉されなかったエラーをグローバルにハンドリングする方法も検討します。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="エラーの発生箇所とグローバルにハンドリングする方法"></a>エラーの発生箇所とグローバルにハンドリングする方法<a class="hash-link" href="#エラーの発生箇所とグローバルにハンドリングする方法" title="見出しへの直接リンク">#</a></h3><p>エラーが発生する箇所とそれぞれのエラーをグローバルにハンドリングする方法は以下になります。</p><table><thead><tr><th align="left">エラー発生箇所</th><th align="left">エラーのハンドリング方法</th></tr></thead><tbody><tr><td align="left">Reactコンポーネント - JSX</td><td align="left">・<a href="https://ja.reactjs.org/docs/error-boundaries.html" target="_blank" rel="noopener noreferrer">Error Boundary</a><br>・ErrorUtils</td></tr><tr><td align="left">Reactコンポーネント - 同期処理</td><td align="left">・Error Boundary<br>・ErrorUtils</td></tr><tr><td align="left">Reactコンポーネント - Promise以外の非同期処理（※1）</td><td align="left">・ErrorUtils</td></tr><tr><td align="left">Reactコンポーネント - Promise</td><td align="left">個別にエラーのハンドリングが必要（※2）</td></tr><tr><td align="left">イベントハンドラ - 同期処理</td><td align="left">・ErrorUtils</td></tr><tr><td align="left">イベントハンドラ - Promise以外の非同期処理（※1）</td><td align="left">・ErrorUtils</td></tr><tr><td align="left">イベントハンドラ - Promise</td><td align="left">個別にエラーのハンドリングが必要（※2）</td></tr><tr><td align="left">Native Modules - Android（Java）</td><td align="left">・<a href="https://developer.android.com/reference/java/lang/Thread.UncaughtExceptionHandler?hl=ja" target="_blank" rel="noopener noreferrer">Thread.UncaughtExceptionHandler</a></td></tr><tr><td align="left">Native Modules - iOS（Objective-C）</td><td align="left">・<a href="https://developer.apple.com/documentation/foundation/1409609-nssetuncaughtexceptionhandler?language=objc" target="_blank" rel="noopener noreferrer">NSSetUncaughtExceptionHandler</a> + シグナルハンドラ（※3）</td></tr></tbody></table><p>（※1）<code>setTimeout</code>や<code>requestAnimationFrame</code>に渡すコールバック関数などが該当します。</p><p>（※2）Promiseで発生するエラーをハンドリングする方法としては、<a href="https://github.com/then/promise" target="_blank" rel="noopener noreferrer">rejection-tracking</a>を使用する方法があります。しかし十分な検証ができていない事や、<a href="https://github.com/then/promise#unhandled-rejections" target="_blank" rel="noopener noreferrer">rejection-trackingのドキュメント</a>において全てのエラーを捕捉することは開発時のみ使用することが推奨されているため、ここには載せていません。</p><p>（※3）<code>NSSetUncaughtExceptionHandler</code>は<a href="https://developer.apple.com/documentation/foundation/nsexception?language=objc" target="_blank" rel="noopener noreferrer">NSException</a>を捕捉しますが、独自に作成したエラーオブジェクトなどは捕捉しません。<code>NSSetUncaughtExceptionHandler</code>で捕捉できないエラーは、<a href="https://developer.apple.com/documentation/kernel/1591562-signal/" target="_blank" rel="noopener noreferrer">signal</a>を使用してシグナルハンドラを登録します。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="エラーを捕捉した後にどのような処理を実施したいか"></a>エラーを捕捉した後に、どのような処理を実施したいか<a class="hash-link" href="#エラーを捕捉した後にどのような処理を実施したいか" title="見出しへの直接リンク">#</a></h3><p>エラーを捕捉した後に、実施する想定の処理は以下になります。</p><ul><li>エラーログをFirebase Crashlyticsに送信</li><li>アプリをクラッシュさせない</li><li>エラーの内容をUIで表示</li><li>アプリを再起動</li></ul><p>アプリが動作するプラットフォームやエラーの発生箇所、エラーハンドリング方法によって実現可否が変わるため、まずはそれらを整理します。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithHideOnScrollNavbar_3R7-" id="以降の表で使用する凡例"></a>以降の表で使用する凡例<a class="hash-link" href="#以降の表で使用する凡例" title="見出しへの直接リンク">#</a></h4><table><thead><tr><th align="left">凡例</th><th align="left">概要</th></tr></thead><tbody><tr><td align="left">◎</td><td align="left">独自に追加実装しなくても実現可能</td></tr><tr><td align="left">○</td><td align="left">独自に追加実装することで実現可能</td></tr><tr><td align="left">×</td><td align="left">実現不可、または実現する方法が見つかっていない</td></tr></tbody></table><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithHideOnScrollNavbar_3R7-" id="reactコンポーネント---jsxや同期処理で発生するエラー"></a>Reactコンポーネント - JSXや同期処理で発生するエラー<a class="hash-link" href="#reactコンポーネント---jsxや同期処理で発生するエラー" title="見出しへの直接リンク">#</a></h4><table><thead><tr><th align="left">処理</th><th align="left">Error Boundary</th><th align="left">ErrorUtils</th><th align="left">React Native Firebase Crashlytics（※1）</th></tr></thead><tbody><tr><td align="left">エラーログをFirebase Crashlyticsに送信</td><td align="left">○</td><td align="left">○</td><td align="left">◎</td></tr><tr><td align="left">アプリをクラッシュさせない</td><td align="left">○</td><td align="left">○</td><td align="left">○</td></tr><tr><td align="left">エラーの内容をUIで表示</td><td align="left">○</td><td align="left">○（※2）</td><td align="left">○（※2）</td></tr><tr><td align="left">アプリを再起動</td><td align="left">○（※3）</td><td align="left">○（※4）</td><td align="left">○（※4）</td></tr></tbody></table><p>（※1）React Native Firebase CrashlyticsはJavaScriptで発生したエラーのハンドリングにErrorUtilsを使用しています。ErrorUtilsはハンドリングしたい処理をハンドラとして登録できます。そのため、React Native Firebase Crashlytics以外にも別の処理を追加したい場合は、独自に作成したハンドラをErrorUtilsに登録することで実現できます。</p><p>（※2）ErrorUtilsで捕捉したエラーの内容をUIで表示するには、Native Modulesを呼び出してUIを表示する必要があります。</p><p>（※3）Reactコンポーネントツリーの最上位から再構築します。</p><p>（※4）JavaScriptのランタイムにバンドルされているモジュールをリロードするか、Androidの場合はActivityを再構築します。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithHideOnScrollNavbar_3R7-" id="reactコンポーネント---promise以外の非同期処理で発生するエラー"></a>Reactコンポーネント - Promise以外の非同期処理で発生するエラー<a class="hash-link" href="#reactコンポーネント---promise以外の非同期処理で発生するエラー" title="見出しへの直接リンク">#</a></h4><table><thead><tr><th align="left">処理</th><th align="left">ErrorUtils</th><th align="left">React Native Firebase Crashlytics（※1）</th></tr></thead><tbody><tr><td align="left">エラーログをFirebase Crashlyticsに送信</td><td align="left">○</td><td align="left">◎</td></tr><tr><td align="left">アプリをクラッシュさせない</td><td align="left">○</td><td align="left">○</td></tr><tr><td align="left">エラーの内容をUIで表示</td><td align="left">○（※2）</td><td align="left">○（※2）</td></tr><tr><td align="left">アプリを再起動</td><td align="left">○（※3）</td><td align="left">○（※3）</td></tr></tbody></table><p>（※1）React Native Firebase CrashlyticsはJavaScriptで発生したエラーのハンドリングにErrorUtilsを使用しています。ErrorUtilsはハンドリングしたい処理をハンドラとして登録できます。そのため、React Native Firebase Crashlytics以外にも別の処理を追加したい場合は、独自に作成したハンドラをErrorUtilsに登録することで実現できます。</p><p>（※2）ErrorUtilsで捕捉したエラーの内容をUIで表示するには、Native Modulesを呼び出してUIを表示する必要があります。</p><p>（※3）JavaScriptのランタイムにバンドルされているモジュールをリロードするか、Androidの場合はActivityを再構築します。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithHideOnScrollNavbar_3R7-" id="イベントハンドラ---同期処理やpromise以外の非同期処理で発生するエラー"></a>イベントハンドラ - 同期処理やPromise以外の非同期処理で発生するエラー<a class="hash-link" href="#イベントハンドラ---同期処理やpromise以外の非同期処理で発生するエラー" title="見出しへの直接リンク">#</a></h4><table><thead><tr><th align="left">処理</th><th align="left">ErrorUtils</th><th align="left">React Native Firebase Crashlytics（※1）</th></tr></thead><tbody><tr><td align="left">エラーログをFirebase Crashlyticsに送信</td><td align="left">○</td><td align="left">◎</td></tr><tr><td align="left">アプリをクラッシュさせない</td><td align="left">○</td><td align="left">○</td></tr><tr><td align="left">エラーの内容をUIで表示</td><td align="left">○（※2）</td><td align="left">○（※2）</td></tr><tr><td align="left">アプリを再起動</td><td align="left">○（※3）</td><td align="left">○（※3）</td></tr></tbody></table><p>（※1）React Native Firebase CrashlyticsはJavaScriptで発生したエラーのハンドリングにErrorUtilsを使用しています。ErrorUtilsはハンドリングしたい処理をハンドラとして登録できます。そのため、React Native Firebase Crashlytics以外にも別の処理を追加したい場合は、独自に作成したハンドラをErrorUtilsに登録することで実現できます。</p><p>（※2）ErrorUtilsで捕捉したエラーの内容をUIで表示するには、Native Modulesを呼び出してUIを表示する必要があります。</p><p>（※3）JavaScriptのランタイムにバンドルされているモジュールをリロードするか、Androidの場合はActivityを再構築します。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithHideOnScrollNavbar_3R7-" id="native-modules---androidjava"></a>Native Modules - Android（Java）<a class="hash-link" href="#native-modules---androidjava" title="見出しへの直接リンク">#</a></h4><table><thead><tr><th align="left">処理</th><th align="left"><code>Thread.UncaughtExceptionHandler</code></th><th align="left">React Native Firebase Crashlytics（※1）</th></tr></thead><tbody><tr><td align="left">エラーログをFirebase Crashlyticsに送信</td><td align="left">○</td><td align="left">◎</td></tr><tr><td align="left">アプリをクラッシュさせない</td><td align="left">○</td><td align="left">×</td></tr><tr><td align="left">エラーの内容をUIで表示</td><td align="left">○</td><td align="left">×</td></tr><tr><td align="left">アプリを再起動</td><td align="left">○（※2）</td><td align="left">×</td></tr></tbody></table><p>（※1）React Native Firebase Crashlyticsは、Native Modulesのエラーハンドリングに<a href="https://github.com/firebase/firebase-android-sdk/tree/master/firebase-crashlytics" target="_blank" rel="noopener noreferrer">Firebase Crashlytics SDK</a>を使用しています。</p><p>（※2）Activityを再構築します。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithHideOnScrollNavbar_3R7-" id="native-modules---iosobjective-c"></a>Native Modules - iOS（Objective-C）<a class="hash-link" href="#native-modules---iosobjective-c" title="見出しへの直接リンク">#</a></h4><table><thead><tr><th align="left">処理</th><th align="left"><code>NSSetUncaughtExceptionHandler</code> + シグナルハンドラ</th><th align="left">React Native Firebase Crashlytics（※1）</th></tr></thead><tbody><tr><td align="left">エラーログをFirebase Crashlyticsに送信</td><td align="left">○</td><td align="left">◎</td></tr><tr><td align="left">アプリをクラッシュさせない</td><td align="left">○</td><td align="left">×</td></tr><tr><td align="left">エラーの内容をUIで表示</td><td align="left">○</td><td align="left">×</td></tr><tr><td align="left">アプリを再起動</td><td align="left">×</td><td align="left">×</td></tr></tbody></table><p>（※1）React Native Firebase Crashlyticsは、Native Modulesのエラーハンドリングに<a href="https://github.com/firebase/firebase-ios-sdk/tree/master/Crashlytics" target="_blank" rel="noopener noreferrer">Firebase Crashlytics SDK</a>を使用しています。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="エラーを捕捉した後に実施する処理の再検討"></a>エラーを捕捉した後に実施する処理の再検討<a class="hash-link" href="#エラーを捕捉した後に実施する処理の再検討" title="見出しへの直接リンク">#</a></h3><p>これまでの議論の中で、エラーを捕捉した後に実施する処理として、「アプリをクラッシュさせない」を含めていました。アプリがクラッシュすると、ユーザの離脱率が高くなる一因になるためです。しかし調査を進める中で、「アプリをクラッシュさせない」仕様が最善なのかという疑問が湧いてきました。理由としては以下になります。</p><ul><li>ネイティブ言語のみを使用して構築されたアプリや、React Native、React Native Firebase Crashlyticsを使用して構築されたアプリでは、エラーが発生した場合のデフォルトの動作はアプリがクラッシュする</li><li>アプリのクラッシュを防止しても、「予期しないエラーが発生しました。アプリを再起動してください。」のようなUIを表示してアプリの再起動を促すことしかできない（ユーザの操作としては、アプリがクラッシュした場合とほとんど同等の操作となる）</li><li>iOSにおいて、signalを受け取ってエラーをハンドリングする方法が適切なのかをAppleのドキュメントからは読み取れない</li></ul><p>そのため、エラーを捕捉した後に実施する処理から、「アプリをクラッシュさせない」を削除する方針としました。アプリがクラッシュするため、「エラーの内容をUIで表示」、「アプリを再起動」は実現できなくなります。よって、エラーを捕捉した後の処理としては、「エラーログをFirebase Crashlyticsに送信」のみとなります。</p><p>その場合、これまでの調査から独自に追加実装をする必要がないReact Native Firebase Crashlyticsを使用することが最善と判断できます。よって、グローバルにエラーをハンドリングする方法としてはReact Native Firebase Crashlyticsを採用する方針とします。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="react-native-firebase-crashlyticsを使用したjavascriptのエラーハンドリング"></a>React Native Firebase Crashlyticsを使用したJavaScriptのエラーハンドリング<a class="hash-link" href="#react-native-firebase-crashlyticsを使用したjavascriptのエラーハンドリング" title="見出しへの直接リンク">#</a></h3><p>React Native Firebase Crashlyticsは、JavaScriptで発生したエラーのハンドリングにデフォルトでErrorUtilsを使用しています。ただし、<a href="https://rnfirebase.io/crashlytics/usage#crashlytics-javascript-stacktrace-issue-generation" target="_blank" rel="noopener noreferrer">React Native Firebase Crashlyticsのドキュメント</a>に記載されているように、ErrorUtilsによるハンドリングを無効化できます。その場合は、Firebase Crashlytics SDKによってエラーがハンドリングされます。</p><p>ErrorUtilsを使用したハンドリングの場合、React Native Firebase Crashlyticsが独自にスタックトレースを作成してFirebase Crashlyticsにログを送信します。しかし、送信されたJavaScriptのスタックトレースは以下のように難読化されており、ソースコードとマッピングしないとエラーの発生箇所を特定できません。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly console"><pre tabindex="0" class="prism-code language-console codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Fatal Exception: JavaScriptError</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Error has occurred in synchronous process of EventHandler.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0  ???                            0x0 &lt;unknown&gt; + 857 (main.jsbundle:857:885:857)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1  ???                            0x0 &lt;unknown&gt; + 679 (main.jsbundle:679:2462:679)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2  ???                            0x0 value + 231 (main.jsbundle:231:8209:231)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3  ???                            0x0 value + 231 (main.jsbundle:231:7465:231)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/* ～省略～ */</span></span></code></pre><button type="button" aria-label="クリップボードにコードをコピー" class="copyButton_Ue-o clean-btn">コピー</button></div></div><p>上記のスタックトレースとソースコードをマッピングするには工夫が必要であり時間もかかります。その反面、Firebase Crashlyticsのコンソール上ではエラーの発生箇所毎にログがカテゴライズされ非常に見やすいといった良い点もあります。</p><p>一方、JavaScriptで発生したエラーのハンドリングにFirebase Crashlytics SDKを使用した場合、Firebase Crashlyticsに送信されたスタックトレースは以下のように難読化されています。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly console"><pre tabindex="0" class="prism-code language-console codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Fatal Exception: RCTFatalException: Unhandled JS Exception:</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Error: Error has occurred in synchronous process of EventHandler.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Unhandled JS Exception: Error: Error has occurred in synchronous process of EventHandler., stack:</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;unknown&gt;@857:884</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;unknown&gt;@679:2461</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">value@231:8208</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">value@231:7464</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/* ～省略～ */</span></span></code></pre><button type="button" aria-label="クリップボードにコードをコピー" class="copyButton_Ue-o clean-btn">コピー</button></div></div><p>上記のスタックトレースは、React Nativeが提供している<code>metro-symbolicate</code>を使用することで、容易にスタックトレースとソースコードのマッピングを行うことができます。その反面、Firebase Crashlyticsのコンソール上ではエラーの発生箇所毎にログがカテゴライズされず、視認性の面では劣ります。</p><p>ここまでの内容を簡単にまとめます。</p><table><thead><tr><th align="left">比較内容</th><th align="left">React Native Firebase Crashlytics（ErrorUtils）によるハンドリング</th><th align="left">Firebase Crashlytics SDKによるハンドリング</th></tr></thead><tbody><tr><td align="left">Firebase Crashlyticsのコンソール上におけるエラーの発生箇所の視認性</td><td align="left">○</td><td align="left">×</td></tr><tr><td align="left">スタックトレースとソースコードのマッピングの容易さ</td><td align="left">×</td><td align="left">○</td></tr></tbody></table><p>SantokuAppでは、スタックトレースとソースコードのマッピングの容易さを重視して、Firebase Crashlytics SDKを使用してエラーをハンドリングする方法を採用します。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="決定"></a>決定<a class="hash-link" href="#決定" title="見出しへの直接リンク">#</a></h2><ul><li>基本方針として、エラーの発生する可能性がある箇所については個別にエラーをハンドリングする<ul><li>ユーザにエラーの内容と復旧手順を伝える</li><li>必要に応じてFirebase Crashlyticsにエラーログを送信する</li></ul></li><li>未処理のエラーが発生した場合は、React Native Firebase Crashlyticsを使用してエラーをハンドリングする<ul><li>アプリをクラッシュさせる</li><li>Firebase Crashlyticsにクラッシュログを送信する</li></ul></li></ul><div class="footnotes"><hr><ol><li id="fn-1">SantokuAppでは、Firebase Crashlyticsを使用する前提としていますが、React Nativeに対応しているプロダクトとしては<a href="https://sentry.io/welcome/" target="_blank" rel="noopener noreferrer">Sentry</a>などもあります。<a href="#fnref-1" class="footnote-backref">↩</a></li></ol></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_13-_"><span class="theme-last-updated"><b><time datetime="2021-09-29T06:47:31.000Z">2021/9/29</time></b>に最終更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントのナビゲーション"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/mobile-app-crib-notes/react-native/santoku/decisions"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">« 目次</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/mobile-app-crib-notes/react-native/santoku/decisions/adr-002-http-api-libraries"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">HTTP通信で使用するライブラリ »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#要約" class="table-of-contents__link">要約</a></li><li><a href="#コンテキスト" class="table-of-contents__link">コンテキスト</a></li><li><a href="#議論" class="table-of-contents__link">議論</a><ul><li><a href="#エラーの発生箇所とグローバルにハンドリングする方法" class="table-of-contents__link">エラーの発生箇所とグローバルにハンドリングする方法</a></li><li><a href="#エラーを捕捉した後にどのような処理を実施したいか" class="table-of-contents__link">エラーを捕捉した後に、どのような処理を実施したいか</a></li><li><a href="#エラーを捕捉した後に実施する処理の再検討" class="table-of-contents__link">エラーを捕捉した後に実施する処理の再検討</a></li><li><a href="#react-native-firebase-crashlyticsを使用したjavascriptのエラーハンドリング" class="table-of-contents__link">React Native Firebase Crashlyticsを使用したJavaScriptのエラーハンドリング</a></li></ul></li><li><a href="#決定" class="table-of-contents__link">決定</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contents</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mobile-app-crib-notes/reference">Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">React Native</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mobile-app-crib-notes/react-native/learn">Learn</a></li><li class="footer__item"><a class="footer__link-item" href="/mobile-app-crib-notes/react-native/common-pitfalls">Pitfalls</a></li></ul></div><div class="col footer__col"><div class="footer__title">Related Work</div><ul class="footer__items"><li class="footer__item"><a href="https://fintan.jp" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Fintan<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://fintan.jp/?p=5952" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>SPA + REST API構成のサービス開発リファレンス<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://fintan.jp/?tag=react-native" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Fintan » React Native<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div class="no-content">
<div class="copyright">
  ドキュメントは、<a rel="license" href="https://fintan.jp/?page_id=201" target="_blank">Fintan コンテンツ 使用許諾条項</a>の下に提供されており、コードサンプルは<a rel="license" href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache 2.0 License</a>の下に提供されています。
</div>
<div class="supplementary">
  <a href="/mobile-app-crib-notes/terms-of-use/" class="footer__link-item">当サイトのご利用にあたって</a>
  <a href="/mobile-app-crib-notes/trademark/" class="footer__link-item">商標について</a>
</div>
</div>
</div></div></div></footer></div>
<script src="/mobile-app-crib-notes/assets/js/runtime~main.168a25f6.js"></script>
<script src="/mobile-app-crib-notes/assets/js/main.195b5258.js"></script>
</body>
</html>