---
title: 演習課題
---

ここまで出来たら、次の演習課題にチャレンジしてください。
サンプルおよびガイドはありません。今までの実装をヒントにできるはずです。

## ユーザ登録画面の作成

ログイン画面を参考に、ユーザ登録画面を作成してください。
その際、ユーザ登録画面のパスワードは4桁以上が必要というチェックを追加してください。

- [ユーザ登録画面](../app-spec.md#ユーザ登録)

## ToDoの削除

ToDoの削除機能を追加してください。

:::note
ToDo一覧画面に削除ボタンを追加する方法が簡単です。
その場合、[確認ダイアログ](alert.mdx)との組み合わせで考えてみてください。
もちろん、違った形で実装しても問題ありません。
:::

## 実装の注意点と不具合の確認

画面の実装時には詳しく説明していませんが、次のような実装には注意が必要です。

 - [ToDo一覧画面](./todo-board.mdx)のステータスの更新処理
 - [ToDo登録画面](./todo-form.mdx)の登録後に自動でModal画面を閉じる処理

上記の処理はREST APIに接続をすると不具合が顕在化する実装をしてしまうケースがあります。
演習課題では不具合が発生する実装を紹介しますので、実際に不具合を確認し何が問題かを考えてみてください。

### ToDo一覧画面のステータスの更新処理

ここでは、ToDoのステータスを連続して更新したときに発生する不具合を紹介します。

まず不具合が発生するように（間違えやすい）実装に変更します。
`TodoBoard.tsx`の`toggleTodoCompletion`を次のように書き換えてください。

```typescript title="/src/screens/todo/TodoBoard.tsx"
  const toggleTodoCompletion = (id: number) => {
    const target = todos.find((todo) => todo.id === id);
    if (!target) {
      return;
    }
    TodoService.putTodo(id, !target.completed)
      .then((returnedTodo) => setTodos(todos.map((todo) => (todo.id === id ? returnedTodo : todo))))
      .catch(() => {});
  };
```

正しくは`setTodos`に関数を渡す[関数型の更新](https://ja.reactjs.org/docs/hooks-reference.html#functional-updates)を利用すべきですが
この実装ではレンダリング時の値を参照して更新しています。

次に不具合を再現できるように実装を修正しましょう。
REST APIに接続すれば不具合は再現できますが、準備に時間がかかるため、ここではREST APIに接続した場合と同じ状況を再現します。

`TodoService.ts`の`putTodo`を次のように書き換えてください。

```typescript jsx title="/src/services/TodoService.ts"
const putTodo = async (id: number, completed: boolean) => {
  const target = todos.find((todo) => todo.id === id);
  if (!target) {
    return Promise.reject(new Error('not found'));
  }
  target.completed = completed;
  return new Promise((resolve) => setTimeout(() => resolve({...target}), 3000));
};

```

このように実装することで`Promise`を返す（`resolve`する）までに3秒程度待つことになり、返されるToDoも`TodoService`が参照しているオブジェクトとは別のインスタンスになります。

`TodoBoard.tsx`と`TodoService.ts`を修正したらアプリを起動して、複数のToDoのステータスを連続して更新してみましょう。

まず、全てのToDoを未完了にします。次に未完了のものを上から順番に連続でタップしてみてください。

全て完了になるはずですが、未完了に戻ってしまうことがあります。

なぜこのような問題が発生するか考えてみてください。

:::note
ヒント：不具合が発生するのはレンダリング時の`todos`をベースに更新していることが関係しています。
:::

### ToDo登録画面の登録後に自動でModal画面を閉じる処理

ここではScreenの表示状態を判定しないと「登録処理待ちのときに登録画面を閉じる」ときに発生する不具合を紹介します。

まず不具合が発生するように（間違えやすい）実装に修正します。
`TodoForm.tsx`の`onAdd`を次のように書き換えてください。

```typescript title="/src/screens/todo/TodoForm.tsx"
  const onAdd = useCallback<(values: {todo: string}) => void>(
    async ({todo}) => {
      await TodoService.postTodo(todo);
      navigation.goBack();
    },
    [navigation],
  );

```

正しくは画面が表示されている場合（`navigation.isFocused()`が`true`の場合）のみ`navigation.goBack()`を呼ぶべきですが、
この実装では`postTodo`が完了したら必ず呼びます。

次に不具合を再現できるように実装を修正しましょう。
「関数型のState更新」と同様に`TodoService.ts`の`postTodo`を修正します。

```typescript title="/src/services/TodoService.ts"
const postTodo = async (text: string) => {
  id++;
  const todo: Todo = {
    id,
    text,
    completed: false,
  };
  todos.push(todo);
  return new Promise((resolve) => setTimeout(() => resolve(todo), 3000));
};

```

`TodoForm.tsx`と`TodoService.ts`を修正したらアプリを起動して、画面下のタブでHome、設定、Homeと遷移してください。

その後、右下の追加ボタンからToDo登録画面を表示して、ToDoを登録し、すぐに右上の閉じるボタンで画面を閉じてください。

Homeタブ（ToDo一覧）が表示されたままになるはずですが、設定タブ（ログアウトボタンのある画面）が表示されてしまいます。

なぜこのような問題が発生するか考えてみてください。

:::note
演習課題後は不具合が発生する実装を戻してください。

- [TodoService.ts](./todo-board.mdx#todo機能関連の部品)のputToDo,postToDo
- [TodoBoard.tsx](./todo-board.mdx#todo一覧画面の作成)
- [TodoForm.tsx](./todo-form.mdx)
:::
