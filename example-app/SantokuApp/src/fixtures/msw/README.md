# MSWの利用

このアプリでは、API通信のデータモックとしてMSWを使用しています。
環境設定ファイル（.env.xxx）の`MSW_ENABLED`の値によって、MSWの有効・無効が切り替わります。
MSWが有効化された場合、API通信は全てMSWによってインターセプトされます。

MSWのデータの管理は、[@mswjs/data](https://github.com/mswjs/data)を使用してます。

## アカウントの種類

MSWを有効化した場合、初期データとして以下の3つのアカウントを用意しています。
それぞれのアカウントが参照する`@mswjs/data`のデータベースも分けており、例えばadminアカウントでイベントを登録した場合、santokuアカウントやpartnerアカウントのデータベースには反映されません。

| アカウントID | アカウント種別 | db名 | 特徴 |
|:--|:--|:--|:--|
| santoku | なし | db | 実際の運用に近いデータを作成しています。境界値のテスト以外に有用なアカウントです。 |
| admin | administrator,techlead | maxDb | 最大桁数の検証を実施したい場合に有用なアカウントです。一覧データも大量に作成しています。 |
| partner | partner | minDb | 最小桁数の検証を実施したい場合に有用なアカウントです。一覧データは初期データとして存在しません。 |

なお、上記以外のアカウントを新規登録した場合は、santokuアカウントと同じデータベースに保存されます。

## 構成

`fixtures/msw`には、大きく以下の3つのディレクトリがあります。

* models
* datas
* handlers

### models

`@mswjs/data`で使用するデータモデルを定義しています。

### datas

`@mswjs/data`で初期データとして投入するデータを定義しています。
ファイル名のプレフィックスによって、どのデータベースにデータを投入するかを分かるようにしています。

| サフィックス | db名 |
|:--|:--|
| Data | db |
| MaxData | maxDb |
| MinData | minDb |

アカウントに紐づかないデータ（未認証でも取得できるデータ）は、`db`に投入しています。
このアプリでは、利用規約のURLや、サポートしているアプリのバージョンを取得するAPIなどが該当します。

### handlers

API通信のハンドラを定義しています。
各HTTPリクエストのURLとメソッドに対応するハンドラを定義します。

#### レスポンスのdelay

各ハンドラが受け取ったリクエストは、デフォルトで1000ms後にレスポンスを返却します。
特定にリクエストでdelayする値を変更したい場合は、以下のように設定してください。

```typescript
return delayedResponse(ctx.json(account), ctx.delay(100))
```

現状は、アプリ起動後のデータロードをスピーディに終えて開発効率を高めたいため、以下のハンドラのdelayを100msに設定しています。
- getSystemCsrfToken
- getAccountsMe
- getAccountsMeTerms
- postLogin
- getSystemAppUpdatesTypeVersion

#### レスポンスのステータスコード

現状、レスポンスのステータスコードは2xx系のみ返却します。（一部、MSW内でエラーが発生した場合は、404や500を返却しますが、基本的には発生しない想定です。）
特定にリクエストのエラー処理を検証したい場合などは、以下のように実装することで任意のステータスコードを返却できます。

```typescript
return delayedResponse(ctx.status(400));
```

## ログイン時のパスワード

MSWを有効化した場合、ログイン時のパスワードは検証していません。
そのため、ログイン画面で入力するパスワードは、クライアントバリデーションの検証をパスする値であれば、どんな値でも問題ありません。
